import{_ as r,C as E,c as d,o as n,a0 as h,b as t,j as p,w as i,a,G as k,a2 as e}from"./chunks/framework.DXI-tbPr.js";const C=JSON.parse('{"title":"Celery 异步任务队列完整指南","description":"Celery 异步任务队列实战指南，包含 FastAPI 集成、数据库连接管理、异步任务编写、常见问题解决方案和性能优化建议。基于实际项目经验，专注于生产环境最佳实践。","frontmatter":{"title":"Celery 异步任务队列完整指南","description":"Celery 异步任务队列实战指南，包含 FastAPI 集成、数据库连接管理、异步任务编写、常见问题解决方案和性能优化建议。基于实际项目经验，专注于生产环境最佳实践。","date":"2026-01-19T15:16:00.000Z","tags":["Celery","Python"]},"headers":[],"relativePath":"posts/Celery 异步任务队列完整指南.md","filePath":"posts/Celery 异步任务队列完整指南.md","lastUpdated":1768877698000}'),g={name:"posts/Celery 异步任务队列完整指南.md"};function o(y,s,c,F,A,u){const l=E("Mermaid");return n(),d("div",null,[s[7]||(s[7]=h("",17)),(n(),t(e,null,{default:i(()=>[k(l,{id:"mermaid-207",class:"mermaid",graph:"graph%20LR%0A%20%20%20%20A%5BProducer%3Cbr%2F%3EFastAPI%E5%BA%94%E7%94%A8%5D%20--%3E%7C%E5%8F%91%E9%80%81%E4%BB%BB%E5%8A%A1%7C%20B%5BBroker%3Cbr%2F%3ERedis%2FRabbitMQ%5D%0A%20%20%20%20B%20--%3E%7C%E5%88%86%E5%8F%91%E4%BB%BB%E5%8A%A1%7C%20C%5BWorker%3Cbr%2F%3E%E4%BB%BB%E5%8A%A1%E6%89%A7%E8%A1%8C%E8%BF%9B%E7%A8%8B%5D%0A%20%20%20%20C%20--%3E%7C%E5%AD%98%E5%82%A8%E7%BB%93%E6%9E%9C%7C%20D%5BBackend%3Cbr%2F%3E%E7%BB%93%E6%9E%9C%E5%AD%98%E5%82%A8%5D%0A%20%20%20%20A%20--%3E%7C%E6%9F%A5%E8%AF%A2%E7%BB%93%E6%9E%9C%7C%20D%0A%20%20%20%20%0A%20%20%20%20style%20A%20fill%3A%23e1f5ff%0A%20%20%20%20style%20B%20fill%3A%23fff4e1%0A%20%20%20%20style%20C%20fill%3A%23e8f5e9%0A%20%20%20%20style%20D%20fill%3A%23f3e5f5%0A"})]),fallback:i(()=>[...s[0]||(s[0]=[a(" Loading... ",-1)])]),_:1})),s[8]||(s[8]=h("",27)),(n(),t(e,null,{default:i(()=>[k(l,{id:"mermaid-329",class:"mermaid",graph:"graph%20TB%0A%20%20%20%20subgraph%20%22Web%E5%B1%82%22%0A%20%20%20%20%20%20%20%20A%5BFastAPI%E5%BA%94%E7%94%A8%5D%20--%3E%7CBackgroundTasks%7C%20B%5BCelery%20Client%5D%0A%20%20%20%20end%0A%20%20%20%20%0A%20%20%20%20subgraph%20%22%E6%B6%88%E6%81%AF%E5%B1%82%22%0A%20%20%20%20%20%20%20%20B%20--%3E%7C%E5%8F%91%E9%80%81%E4%BB%BB%E5%8A%A1%7C%20C%5BRedis%20Broker%5D%0A%20%20%20%20%20%20%20%20C%20--%3E%7C%E4%BB%BB%E5%8A%A1%E9%98%9F%E5%88%97%7C%20D%5BCelery%20Worker%5D%0A%20%20%20%20%20%20%20%20D%20--%3E%7C%E7%BB%93%E6%9E%9C%7C%20E%5BRedis%20Backend%5D%0A%20%20%20%20end%0A%20%20%20%20%0A%20%20%20%20subgraph%20%22Worker%E8%BF%9B%E7%A8%8B%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%22%0A%20%20%20%20%20%20%20%20D%20--%3E%7Cworker_process_init%7C%20F%5B%E5%88%9B%E5%BB%BA%E5%85%A8%E5%B1%80Loop%5D%0A%20%20%20%20%20%20%20%20F%20--%3E%7C%E5%88%9B%E5%BB%BA%7C%20G%5B%E5%85%A8%E5%B1%80AsyncEngine%3Cbr%2F%3ENullPool%5D%0A%20%20%20%20%20%20%20%20G%20--%3E%7C%E5%88%9B%E5%BB%BA%7C%20H%5B%E5%85%A8%E5%B1%80SessionMaker%5D%0A%20%20%20%20%20%20%20%20H%20--%3E%7C%E4%BB%BB%E5%8A%A1%E6%89%A7%E8%A1%8C%7C%20I%5B%E8%8E%B7%E5%8F%96Session%5D%0A%20%20%20%20%20%20%20%20I%20--%3E%7C%E6%89%A7%E8%A1%8C%E4%BB%BB%E5%8A%A1%7C%20J%5B(PostgreSQL)%5D%0A%20%20%20%20end%0A%20%20%20%20%0A%20%20%20%20subgraph%20%22%E6%95%B0%E6%8D%AE%E5%B1%82%22%0A%20%20%20%20%20%20%20%20A%20--%3E%7CWeb%20Engine%3Cbr%2F%3EQueuePool%7C%20K%5B(PostgreSQL)%5D%0A%20%20%20%20end%0A%20%20%20%20%0A%20%20%20%20subgraph%20%22%E4%BB%BB%E5%8A%A1%E6%A8%A1%E5%9D%97%22%0A%20%20%20%20%20%20%20%20D%20--%3E%20L%5Bmodules.file.tasks%5D%0A%20%20%20%20%20%20%20%20D%20--%3E%20M%5Bmodules.other.tasks%5D%0A%20%20%20%20end%0A%20%20%20%20%0A%20%20%20%20style%20A%20fill%3A%23e1f5ff%0A%20%20%20%20style%20D%20fill%3A%23e8f5e9%0A%20%20%20%20style%20C%20fill%3A%23fff4e1%0A%20%20%20%20style%20E%20fill%3A%23fff4e1%0A%20%20%20%20style%20K%20fill%3A%23f3e5f5%0A%20%20%20%20style%20J%20fill%3A%23f3e5f5%0A"})]),fallback:i(()=>[...s[1]||(s[1]=[a(" Loading... ",-1)])]),_:1})),s[9]||(s[9]=h("",14)),(n(),t(e,null,{default:i(()=>[k(l,{id:"mermaid-395",class:"mermaid",graph:"sequenceDiagram%0A%20%20%20%20participant%20Main%20as%20%E4%B8%BB%E8%BF%9B%E7%A8%8B%0A%20%20%20%20participant%20Worker%20as%20Worker%E5%AD%90%E8%BF%9B%E7%A8%8B%0A%20%20%20%20participant%20Loop%20as%20Event%20Loop%0A%20%20%20%20participant%20Engine%20as%20AsyncEngine%0A%20%20%20%20%0A%20%20%20%20Main-%3E%3EWorker%3A%20fork%E5%AD%90%E8%BF%9B%E7%A8%8B%0A%20%20%20%20Worker-%3E%3ELoop%3A%20worker_process_init%E4%BF%A1%E5%8F%B7%0A%20%20%20%20Loop-%3E%3ELoop%3A%20%E5%88%9B%E5%BB%BA%E5%85%A8%E5%B1%80Event%20Loop%0A%20%20%20%20Loop-%3E%3EEngine%3A%20%E5%88%9B%E5%BB%BAAsyncEngine%EF%BC%88%E7%BB%91%E5%AE%9ALoop%EF%BC%89%0A%20%20%20%20Engine-%3E%3ELoop%3A%20%E5%88%9B%E5%BB%BASessionMaker%0A%20%20%20%20%0A%20%20%20%20Note%20over%20Worker%2CLoop%3A%20Worker%E8%BF%9B%E7%A8%8B%E8%BF%90%E8%A1%8C%E4%B8%AD%0A%20%20%20%20%0A%20%20%20%20Worker-%3E%3ELoop%3A%20%E4%BB%BB%E5%8A%A11%E6%89%A7%E8%A1%8C%0A%20%20%20%20Loop-%3E%3EEngine%3A%20%E8%8E%B7%E5%8F%96Session%0A%20%20%20%20Engine-%3E%3ELoop%3A%20%E6%89%A7%E8%A1%8C%E5%BC%82%E6%AD%A5%E4%BB%A3%E7%A0%81%0A%20%20%20%20Loop-%3E%3EEngine%3A%20%E5%BD%92%E8%BF%98Session%0A%20%20%20%20%0A%20%20%20%20Worker-%3E%3ELoop%3A%20%E4%BB%BB%E5%8A%A12%E6%89%A7%E8%A1%8C%EF%BC%88%E5%A4%8D%E7%94%A8%E5%90%8C%E4%B8%80%E4%B8%AALoop%EF%BC%89%0A%20%20%20%20Loop-%3E%3EEngine%3A%20%E8%8E%B7%E5%8F%96Session%0A%20%20%20%20%0A%20%20%20%20Note%20over%20Worker%2CLoop%3A%20Worker%E8%BF%9B%E7%A8%8B%E5%85%B3%E9%97%AD%0A%20%20%20%20Worker-%3E%3EEngine%3A%20worker_process_shutdown%E4%BF%A1%E5%8F%B7%0A%20%20%20%20Engine-%3E%3EEngine%3A%20dispose()%E9%87%8A%E6%94%BE%E8%BF%9E%E6%8E%A5%0A%20%20%20%20Engine-%3E%3ELoop%3A%20%E5%85%B3%E9%97%ADLoop%0A"})]),fallback:i(()=>[...s[2]||(s[2]=[a(" Loading... ",-1)])]),_:1})),s[10]||(s[10]=h("",22)),(n(),t(e,null,{default:i(()=>[k(l,{id:"mermaid-484",class:"mermaid",graph:"graph%20TD%0A%20%20%20%20A%5BCelery%20Worker%3Cbr%2F%3E%E5%90%8C%E6%AD%A5%E8%BF%9B%E7%A8%8B%5D%20--%3E%7C%E8%8E%B7%E5%8F%96%E5%85%A8%E5%B1%80Loop%7C%20B%5BWorker%E5%85%A8%E5%B1%80Loop%5D%0A%20%20%20%20B%20--%3E%7Cget_worker_session_maker%7C%20C%5B%E5%88%9B%E5%BB%BASession%3Cbr%2F%3ENullPool%20Engine%5D%0A%20%20%20%20C%20--%3E%7C%E6%89%A7%E8%A1%8C%E4%B8%9A%E5%8A%A1%E9%80%BB%E8%BE%91%7C%20D%5Bprocess_func%5D%0A%20%20%20%20D%20--%3E%7C%E6%88%90%E5%8A%9F%7C%20E%5Bcommit%E4%BA%8B%E5%8A%A1%5D%0A%20%20%20%20D%20--%3E%7C%E5%A4%B1%E8%B4%A5%7C%20F%5Brollback%E4%BA%8B%E5%8A%A1%5D%0A%20%20%20%20E%20--%3E%7C%E8%AE%B0%E5%BD%95%E6%97%A5%E5%BF%97%7C%20G%5B%E8%BF%94%E5%9B%9E%E7%BB%93%E6%9E%9C%5D%0A%20%20%20%20F%20--%3E%7C%E8%AE%B0%E5%BD%95%E9%94%99%E8%AF%AF%E6%97%A5%E5%BF%97%7C%20H%5B%E6%8A%9B%E5%87%BA%E5%BC%82%E5%B8%B8%5D%0A%20%20%20%20G%20--%3E%7CLoop%E6%8C%81%E7%BB%AD%E8%BF%90%E8%A1%8C%7C%20I%5B%E4%BB%BB%E5%8A%A1%E5%AE%8C%E6%88%90%5D%0A%20%20%20%20H%20--%3E%7CLoop%E6%8C%81%E7%BB%AD%E8%BF%90%E8%A1%8C%7C%20I%0A%20%20%20%20%0A%20%20%20%20style%20A%20fill%3A%23e8f5e9%0A%20%20%20%20style%20B%20fill%3A%23fff4e1%0A%20%20%20%20style%20C%20fill%3A%23e1f5ff%0A%20%20%20%20style%20D%20fill%3A%23f3e5f5%0A"})]),fallback:i(()=>[...s[3]||(s[3]=[a(" Loading... ",-1)])]),_:1})),s[11]||(s[11]=h("",17)),(n(),t(e,null,{default:i(()=>[k(l,{id:"mermaid-550",class:"mermaid",graph:"sequenceDiagram%0A%20%20%20%20participant%20Router%20as%20FastAPI%20Router%0A%20%20%20%20participant%20Service%20as%20Service%20Layer%0A%20%20%20%20participant%20DB%20as%20Database%3Cbr%2F%3E(%E4%BA%8B%E5%8A%A1%E4%B8%AD)%0A%20%20%20%20participant%20BG%20as%20BackgroundTasks%0A%20%20%20%20participant%20Worker%20as%20Celery%20Worker%0A%20%20%20%20%0A%20%20%20%20Router-%3E%3EService%3A%20upload_file()%0A%20%20%20%20Service-%3E%3EDB%3A%20INSERT%20file%20(%E4%BA%8B%E5%8A%A1%E4%B8%AD)%0A%20%20%20%20Service-%3E%3EBG%3A%20add_task(trigger_celery)%0A%20%20%20%20Service-%3E%3ERouter%3A%20return%20response%0A%20%20%20%20Router-%3E%3ERouter%3A%20%E5%8F%91%E9%80%81%E5%93%8D%E5%BA%94%0A%20%20%20%20Note%20over%20Router%2CDB%3A%20%E5%93%8D%E5%BA%94%E5%8F%91%E9%80%81%E5%90%8E%EF%BC%8C%E4%BA%8B%E5%8A%A1%E8%87%AA%E5%8A%A8%20Commit%0A%20%20%20%20%0A%20%20%20%20BG-%3E%3EWorker%3A%20task.delay()%20(%E5%8F%91%E9%80%81%E6%B6%88%E6%81%AF)%0A%20%20%20%20Worker-%3E%3EDB%3A%20SELECT%20file%0A%20%20%20%20Note%20over%20Worker%2CDB%3A%20%E2%9C%85%20%E6%AD%A4%E6%97%B6%E4%B8%80%E5%AE%9A%E8%83%BD%E6%9F%A5%E5%88%B0%EF%BC%8C%E5%9B%A0%E4%B8%BA%E4%BA%8B%E5%8A%A1%E5%B7%B2%20Commit%0A"})]),fallback:i(()=>[...s[4]||(s[4]=[a(" Loading... ",-1)])]),_:1})),s[12]||(s[12]=p("h3",{id:"解决方案-fastapi-backgroundtasks",tabindex:"-1"},[a("解决方案：FastAPI BackgroundTasks "),p("a",{class:"header-anchor",href:"#解决方案-fastapi-backgroundtasks","aria-label":'Permalink to "解决方案：FastAPI BackgroundTasks"'},"​")],-1)),s[13]||(s[13]=p("p",null,[p("strong",null,"核心思路"),a("：利用 FastAPI "),p("code",null,"BackgroundTasks"),a(' 的"响应后执行"特性，确保在数据库事务 Commit 后再触发任务。')],-1)),s[14]||(s[14]=p("p",null,[p("strong",null,"架构流程"),a("：")],-1)),(n(),t(e,null,{default:i(()=>[k(l,{id:"mermaid-560",class:"mermaid",graph:"graph%20TB%0A%20%20%20%20A%5B%E7%94%A8%E6%88%B7%E4%B8%8A%E4%BC%A0%E6%96%87%E4%BB%B6%5D%20--%3E%20B%5BRouter.upload_file%5D%0A%20%20%20%20B%20--%3E%20C%5BService.upload_files_batch%5D%0A%20%20%20%20C%20--%3E%20D%5B%E5%88%9B%E5%BB%BA%E6%96%87%E4%BB%B6%E8%AE%B0%E5%BD%95%3Cbr%2F%3E%E4%BA%8B%E5%8A%A1%E4%B8%AD%5D%0A%20%20%20%20D%20--%3E%20E%5B%E8%BF%94%E5%9B%9E%E6%96%87%E4%BB%B6%E8%AE%B0%E5%BD%95%5D%0A%20%20%20%20E%20--%3E%20F%5BRouter%E6%B3%A8%E5%86%8CBackgroundTasks%5D%0A%20%20%20%20F%20--%3E%20G%5B%E8%BF%94%E5%9B%9EHTTP%E5%93%8D%E5%BA%94%5D%0A%20%20%20%20G%20--%3E%20H%5BFastAPI%E8%87%AA%E5%8A%A8Commit%E4%BA%8B%E5%8A%A1%5D%0A%20%20%20%20H%20--%3E%20I%5BBackgroundTasks%E6%89%A7%E8%A1%8C%5D%0A%20%20%20%20I%20--%3E%20J%5B%E8%A7%A6%E5%8F%91Celery%E4%BB%BB%E5%8A%A1%3Cbr%2F%3Etask.delay%5D%0A%20%20%20%20J%20--%3E%20K%5BCelery%20Worker%E6%89%A7%E8%A1%8C%3Cbr%2F%3E%E4%B8%80%E5%AE%9A%E8%83%BD%E6%9F%A5%E5%88%B0%E6%96%87%E4%BB%B6%E8%AE%B0%E5%BD%95%5D%0A%20%20%20%20%0A%20%20%20%20style%20H%20fill%3A%23e8f5e9%0A%20%20%20%20style%20I%20fill%3A%23fff4e1%0A%20%20%20%20style%20K%20fill%3A%23e8f5e9%0A"})]),fallback:i(()=>[...s[5]||(s[5]=[a(" Loading... ",-1)])]),_:1})),s[15]||(s[15]=h("",64)),(n(),t(e,null,{default:i(()=>[k(l,{id:"mermaid-796",class:"mermaid",graph:"flowchart%20TD%0A%20%20%20%20A%5B%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%5D%20--%3E%7CBackgroundTasks%7C%20B%5B%E8%A7%A6%E5%8F%91embed_file_task%5D%0A%20%20%20%20B%20--%3E%20C%5B%E6%9B%B4%E6%96%B0%E7%8A%B6%E6%80%81%3A%20PROCESSING%5D%0A%20%20%20%20C%20--%3E%20D%5B%E4%B8%8B%E8%BD%BD%E6%96%87%E4%BB%B6%5D%0A%20%20%20%20D%20--%3E%7C%E5%A4%B1%E8%B4%A5%7C%20E%5B%E6%9B%B4%E6%96%B0%E7%8A%B6%E6%80%81%3A%20FAILED%5D%0A%20%20%20%20D%20--%3E%7C%E6%88%90%E5%8A%9F%7C%20F%5B%E8%A7%A3%E6%9E%90%E6%96%87%E4%BB%B6%5D%0A%20%20%20%20F%20--%3E%7C%E5%A4%B1%E8%B4%A5%7C%20E%0A%20%20%20%20F%20--%3E%7C%E6%88%90%E5%8A%9F%7C%20G%7B%E6%98%AF%E5%90%A6%E6%9C%89%E5%9B%BE%E7%89%87%3F%7D%0A%20%20%20%20G%20--%3E%7C%E6%98%AF%7C%20H%5B%E4%B8%8A%E4%BC%A0%E5%9B%BE%E7%89%87%E5%88%B0MinIO%5D%0A%20%20%20%20G%20--%3E%7C%E5%90%A6%7C%20I%5B%E5%90%88%E5%B9%B6%E5%9B%BE%E7%89%87%E5%88%B0%E6%96%87%E6%A1%A3%5D%0A%20%20%20%20H%20--%3E%20I%0A%20%20%20%20I%20--%3E%20J%5B%E5%90%91%E9%87%8F%E5%8C%96%E5%A4%84%E7%90%86%5D%0A%20%20%20%20J%20--%3E%7C%E5%A4%B1%E8%B4%A5%7C%20E%0A%20%20%20%20J%20--%3E%7C%E6%88%90%E5%8A%9F%7C%20K%5B%E6%9B%B4%E6%96%B0%E7%8A%B6%E6%80%81%3A%20COMPLETED%5D%0A%20%20%20%20K%20--%3E%20L%5B%E5%8F%91%E5%B8%83Redis%E9%80%9A%E7%9F%A5%5D%0A%20%20%20%20E%20--%3E%20L%0A%20%20%20%20%0A%20%20%20%20style%20B%20fill%3A%23e8f5e9%0A%20%20%20%20style%20E%20fill%3A%23ffebee%0A%20%20%20%20style%20K%20fill%3A%23e8f5e9%0A"})]),fallback:i(()=>[...s[6]||(s[6]=[a(" Loading... ",-1)])]),_:1})),s[16]||(s[16]=h("",15))])}const D=r(g,[["render",o]]);export{C as __pageData,D as default};

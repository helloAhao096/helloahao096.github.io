import{_ as h,C as d,c,o as i,a0 as e,b as p,j as o,w as a,a as n,G as t,a2 as r}from"./chunks/framework.DXI-tbPr.js";const B=JSON.parse('{"title":"FastAPI 项目工程化结构设计指南","description":"基于实际项目经验，总结 FastAPI 后端项目的工程化目录架构设计原则和最佳实践，提供可复用的、解耦的工程化结构方案","frontmatter":{"title":"FastAPI 项目工程化结构设计指南","description":"基于实际项目经验，总结 FastAPI 后端项目的工程化目录架构设计原则和最佳实践，提供可复用的、解耦的工程化结构方案","date":"2025-11-28T15:23:23.000Z","tags":["FastAPI","Python","工程化","架构设计","后端开发"]},"headers":[],"relativePath":"posts/FastAPI 项目工程化结构设计指南.md","filePath":"posts/FastAPI 项目工程化结构设计指南.md","lastUpdated":1764582741000}'),k={name:"posts/FastAPI 项目工程化结构设计指南.md"};function E(g,s,u,y,A,b){const l=d("Mermaid");return i(),c("div",null,[s[7]||(s[7]=e(`<blockquote><p>本文基于实际 FastAPI 项目经验，从工程化角度分析后端项目结构设计，提取通用的、解耦的架构模式，帮助开发者构建可维护、可扩展、可测试的后端项目。</p></blockquote><h2 id="一、工程化结构设计原则" tabindex="-1">一、工程化结构设计原则 <a class="header-anchor" href="#一、工程化结构设计原则" aria-label="Permalink to &quot;一、工程化结构设计原则&quot;">​</a></h2><h3 id="_1-1-核心设计理念" tabindex="-1">1.1 核心设计理念 <a class="header-anchor" href="#_1-1-核心设计理念" aria-label="Permalink to &quot;1.1 核心设计理念&quot;">​</a></h3><h4 id="关注点分离-separation-of-concerns" tabindex="-1">关注点分离（Separation of Concerns） <a class="header-anchor" href="#关注点分离-separation-of-concerns" aria-label="Permalink to &quot;关注点分离（Separation of Concerns）&quot;">​</a></h4><p>将不同职责的代码分离到不同的目录和文件中，确保每个模块只关注自己的核心功能。</p><p><strong>实践要点：</strong></p><ul><li>API 路由层独立于业务逻辑层</li><li>数据访问层（Repository）与业务逻辑层（Service）分离</li><li>配置管理集中化，避免散落各处</li><li>异常处理统一管理，与业务逻辑分离</li></ul><h4 id="单一职责原则-single-responsibility-principle" tabindex="-1">单一职责原则（Single Responsibility Principle） <a class="header-anchor" href="#单一职责原则-single-responsibility-principle" aria-label="Permalink to &quot;单一职责原则（Single Responsibility Principle）&quot;">​</a></h4><p>每个文件、每个目录都应该有明确的单一职责。</p><p><strong>示例：</strong></p><ul><li><code>routers.py</code> 只负责定义 API 路由和处理 HTTP 请求</li><li><code>services.py</code> 只负责业务逻辑处理</li><li><code>repositories.py</code> 只负责数据访问操作</li><li><code>models.py</code> 只定义数据模型</li></ul><h4 id="模块化与解耦" tabindex="-1">模块化与解耦 <a class="header-anchor" href="#模块化与解耦" aria-label="Permalink to &quot;模块化与解耦&quot;">​</a></h4><p>通过模块化设计降低代码间的耦合度，提高代码的可复用性和可测试性。</p><p><strong>关键实践：</strong></p><ul><li>使用依赖注入（Dependency Injection）实现松耦合</li><li>通过接口和抽象类定义模块间的契约</li><li>避免模块间的直接依赖，通过共享服务层通信</li><li>使用仓储模式（Repository Pattern）抽象数据访问</li></ul><h4 id="可维护性与可扩展性" tabindex="-1">可维护性与可扩展性 <a class="header-anchor" href="#可维护性与可扩展性" aria-label="Permalink to &quot;可维护性与可扩展性&quot;">​</a></h4><p>结构设计应该便于后续的维护和扩展。</p><p><strong>设计考虑：</strong></p><ul><li>新功能应该能够轻松添加到现有结构中</li><li>修改某个模块不应该影响其他模块</li><li>代码结构清晰，新成员能够快速理解</li><li>支持水平扩展和垂直扩展</li></ul><h4 id="类型安全与开发体验" tabindex="-1">类型安全与开发体验 <a class="header-anchor" href="#类型安全与开发体验" aria-label="Permalink to &quot;类型安全与开发体验&quot;">​</a></h4><p>充分利用 Python 的类型提示（Type Hints）和 Pydantic，提升开发效率和代码质量。</p><p><strong>实践建议：</strong></p><ul><li>为所有 API 请求和响应定义 Pydantic 模型</li><li>使用类型提示增强代码可读性</li><li>利用 IDE 的类型检查提升开发体验</li><li>使用 mypy 进行静态类型检查</li></ul><h3 id="_1-2-目录组织原则" tabindex="-1">1.2 目录组织原则 <a class="header-anchor" href="#_1-2-目录组织原则" aria-label="Permalink to &quot;1.2 目录组织原则&quot;">​</a></h3><h4 id="两种核心设计模式" tabindex="-1">两种核心设计模式 <a class="header-anchor" href="#两种核心设计模式" aria-label="Permalink to &quot;两种核心设计模式&quot;">​</a></h4><p>根据项目规模和复杂度，可以抽象出两种结构形态：<strong>扁平化结构（按技术层次）</strong> 和 <strong>混合模式（功能领域 + 技术层次）</strong>。<br> 本指南<strong>默认推荐混合模式</strong>作为中大型、长期维护项目的标准结构，扁平化结构主要用于项目早期或教学对比，是向混合模式演进的起点，而不是最终目标结构。</p><h5 id="模式一-扁平化结构-按技术层次划分" tabindex="-1">模式一：扁平化结构（按技术层次划分） <a class="header-anchor" href="#模式一-扁平化结构-按技术层次划分" aria-label="Permalink to &quot;模式一：扁平化结构（按技术层次划分）&quot;">​</a></h5><blockquote><p>说明：本模式适合小型/早期项目用于快速起步或教学示例，在项目进入多人协作或业务复杂度提升后，应尽快演进到混合模式结构。</p></blockquote><p><strong>完整目录结构：</strong></p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>backend/</span></span>
<span class="line"><span>├── main.py                 # 应用入口</span></span>
<span class="line"><span>├── config.py              # 配置管理</span></span>
<span class="line"><span>├── pyproject.toml         # 项目配置和依赖（使用 uv 管理）</span></span>
<span class="line"><span>├── uv.lock                # 锁定的依赖版本（使用 uv 生成）</span></span>
<span class="line"><span>│</span></span>
<span class="line"><span>├── app/</span></span>
<span class="line"><span>│   ├── __init__.py</span></span>
<span class="line"><span>│   │</span></span>
<span class="line"><span>│   ├── api/               # API 路由层</span></span>
<span class="line"><span>│   │   ├── __init__.py</span></span>
<span class="line"><span>│   │   ├── router.py      # 路由统一注册</span></span>
<span class="line"><span>│   │   ├── users.py       # 用户路由</span></span>
<span class="line"><span>│   │   ├── projects.py    # 项目路由</span></span>
<span class="line"><span>│   │   └── [module].py    # 其他模块路由</span></span>
<span class="line"><span>│   │</span></span>
<span class="line"><span>│   ├── core/              # 核心基础设施层</span></span>
<span class="line"><span>│   │   ├── __init__.py</span></span>
<span class="line"><span>│   │   ├── config.py      # 配置管理</span></span>
<span class="line"><span>│   │   ├── exceptions.py  # 异常定义</span></span>
<span class="line"><span>│   │   ├── handlers.py    # 异常处理器</span></span>
<span class="line"><span>│   │   ├── response.py    # 响应模型</span></span>
<span class="line"><span>│   │   ├── security/       # 安全认证</span></span>
<span class="line"><span>│   │   │   ├── dependencies.py</span></span>
<span class="line"><span>│   │   │   └── jwt_handler.py</span></span>
<span class="line"><span>│   │   └── middleware/     # 中间件</span></span>
<span class="line"><span>│   │</span></span>
<span class="line"><span>│   ├── db/                # 数据库层</span></span>
<span class="line"><span>│   │   ├── __init__.py</span></span>
<span class="line"><span>│   │   ├── base.py        # 基础模型类</span></span>
<span class="line"><span>│   │   ├── connection.py  # 数据库连接</span></span>
<span class="line"><span>│   │   ├── models/        # 数据模型</span></span>
<span class="line"><span>│   │   │   ├── user.py</span></span>
<span class="line"><span>│   │   │   └── project.py</span></span>
<span class="line"><span>│   │   └── repositories/  # 仓储层</span></span>
<span class="line"><span>│   │       ├── user.py</span></span>
<span class="line"><span>│   │       └── project.py</span></span>
<span class="line"><span>│   │</span></span>
<span class="line"><span>│   ├── schemas/           # Pydantic 模式层</span></span>
<span class="line"><span>│   │   ├── __init__.py</span></span>
<span class="line"><span>│   │   ├── common/        # 通用模式</span></span>
<span class="line"><span>│   │   │   ├── response.py</span></span>
<span class="line"><span>│   │   │   └── pagination.py</span></span>
<span class="line"><span>│   │   └── modules/       # 业务模块模式</span></span>
<span class="line"><span>│   │       ├── user/</span></span>
<span class="line"><span>│   │       │   ├── requests.py</span></span>
<span class="line"><span>│   │       │   └── responses.py</span></span>
<span class="line"><span>│   │       └── [module]/</span></span>
<span class="line"><span>│   │</span></span>
<span class="line"><span>│   ├── services/          # 业务逻辑层</span></span>
<span class="line"><span>│   │   ├── __init__.py</span></span>
<span class="line"><span>│   │   ├── user_service.py</span></span>
<span class="line"><span>│   │   ├── project_service.py</span></span>
<span class="line"><span>│   │   └── [module]_service.py</span></span>
<span class="line"><span>│   │</span></span>
<span class="line"><span>│   └── utils/             # 工具函数层</span></span>
<span class="line"><span>│       ├── __init__.py</span></span>
<span class="line"><span>│       ├── format.py</span></span>
<span class="line"><span>│       └── validation.py</span></span>
<span class="line"><span>│</span></span>
<span class="line"><span>├── tests/                 # 测试目录</span></span>
<span class="line"><span>│   ├── __init__.py</span></span>
<span class="line"><span>│   ├── conftest.py</span></span>
<span class="line"><span>│   └── test_*.py</span></span>
<span class="line"><span>│</span></span>
<span class="line"><span>└── scripts/               # 脚本目录</span></span>
<span class="line"><span>    └── migrations/        # 数据库迁移</span></span></code></pre></div><p><strong>特点：</strong></p><ul><li>✅ <strong>认知负担低</strong>：按技术类型分类，直观易懂</li><li>✅ <strong>路径短</strong>：<code>app/services/user_service.py</code>，导入路径简洁</li><li>✅ <strong>共享代码集中</strong>：通用服务、工具函数天然集中，便于复用</li><li>✅ <strong>适合小型项目</strong>：结构简单，上手快，开发效率高</li></ul><p><strong>适用场景：</strong></p><ul><li>项目初期（&lt; 10 个 API 端点）</li><li>小型项目（1-2 人团队）</li><li>功能相对简单，模块边界不清晰</li><li>快速原型开发</li></ul><p><strong>局限性：</strong></p><ul><li>❌ 文件定位困难：<code>services/</code> 下文件多时难以快速定位</li><li>❌ 模块边界模糊：用户相关代码分散在多个目录</li><li>❌ 并行协作冲突：多人修改同一模块时容易冲突</li><li>❌ 模块拆分困难：相关代码分散，难以独立拆分</li></ul><p>综合来看，扁平化结构更适合作为<strong>向混合模式演进之前的过渡形态</strong>，而不是中大型项目的长期目标结构。</p><h5 id="模式二-混合模式-功能领域-技术层次" tabindex="-1">模式二：混合模式（功能领域 + 技术层次） <a class="header-anchor" href="#模式二-混合模式-功能领域-技术层次" aria-label="Permalink to &quot;模式二：混合模式（功能领域 + 技术层次）&quot;">​</a></h5><p><strong>完整目录结构：</strong></p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>backend/</span></span>
<span class="line"><span>├── main.py                 # 应用入口</span></span>
<span class="line"><span>├── config.py              # 配置管理</span></span>
<span class="line"><span>├── pyproject.toml         # 项目配置</span></span>
<span class="line"><span>│</span></span>
<span class="line"><span>├── app/</span></span>
<span class="line"><span>│   ├── __init__.py</span></span>
<span class="line"><span>│   │</span></span>
<span class="line"><span>│   ├── core/              # 核心基础设施层（技术层次）</span></span>
<span class="line"><span>│   │   ├── __init__.py</span></span>
<span class="line"><span>│   │   ├── config.py      # 配置管理</span></span>
<span class="line"><span>│   │   ├── exceptions/    # 异常定义</span></span>
<span class="line"><span>│   │   │   ├── __init__.py</span></span>
<span class="line"><span>│   │   │   ├── base.py</span></span>
<span class="line"><span>│   │   │   └── handlers.py</span></span>
<span class="line"><span>│   │   ├── response.py    # 响应模型</span></span>
<span class="line"><span>│   │   ├── schemas.py     # 通用模式</span></span>
<span class="line"><span>│   │   ├── security/      # 安全认证</span></span>
<span class="line"><span>│   │   │   ├── dependencies.py</span></span>
<span class="line"><span>│   │   │   └── jwt_handler.py</span></span>
<span class="line"><span>│   │   └── middleware/    # 中间件</span></span>
<span class="line"><span>│   │</span></span>
<span class="line"><span>│   ├── db/                # 数据库层（技术层次）</span></span>
<span class="line"><span>│   │   ├── __init__.py</span></span>
<span class="line"><span>│   │   ├── base.py        # 基础模型类</span></span>
<span class="line"><span>│   │   ├── connection.py  # 数据库连接</span></span>
<span class="line"><span>│   │   └── repositories/  # 基础仓储类</span></span>
<span class="line"><span>│   │       └── base.py</span></span>
<span class="line"><span>│   │</span></span>
<span class="line"><span>│   ├── shared/            # 共享服务层（跨模块）</span></span>
<span class="line"><span>│   │   ├── __init__.py</span></span>
<span class="line"><span>│   │   ├── storage/       # 存储服务</span></span>
<span class="line"><span>│   │   │   └── minio_service.py</span></span>
<span class="line"><span>│   │   ├── cache/         # 缓存服务</span></span>
<span class="line"><span>│   │   ├── messaging/     # 消息服务</span></span>
<span class="line"><span>│   │   └── utils/         # 共享工具函数</span></span>
<span class="line"><span>│   │</span></span>
<span class="line"><span>│   ├── modules/           # 业务模块层（功能领域）</span></span>
<span class="line"><span>│   │   ├── __init__.py</span></span>
<span class="line"><span>│   │   │</span></span>
<span class="line"><span>│   │   ├── user/          # 用户模块</span></span>
<span class="line"><span>│   │   │   ├── __init__.py</span></span>
<span class="line"><span>│   │   │   ├── models.py      # 模块数据模型</span></span>
<span class="line"><span>│   │   │   ├── schemas.py     # 模块 Pydantic 模式</span></span>
<span class="line"><span>│   │   │   ├── repositories.py # 模块仓储</span></span>
<span class="line"><span>│   │   │   ├── services.py    # 模块服务</span></span>
<span class="line"><span>│   │   │   ├── routers.py     # 模块路由</span></span>
<span class="line"><span>│   │   │   └── dependencies.py # 模块依赖</span></span>
<span class="line"><span>│   │   │</span></span>
<span class="line"><span>│   │   ├── project/       # 项目模块</span></span>
<span class="line"><span>│   │   │   ├── __init__.py</span></span>
<span class="line"><span>│   │   │   ├── models.py</span></span>
<span class="line"><span>│   │   │   ├── schemas.py</span></span>
<span class="line"><span>│   │   │   ├── repositories.py</span></span>
<span class="line"><span>│   │   │   ├── services.py</span></span>
<span class="line"><span>│   │   │   ├── routers.py</span></span>
<span class="line"><span>│   │   │   └── dependencies.py</span></span>
<span class="line"><span>│   │   │</span></span>
<span class="line"><span>│   │   └── [module]/      # 其他业务模块</span></span>
<span class="line"><span>│   │</span></span>
<span class="line"><span>│   └── api/               # API 统一注册层</span></span>
<span class="line"><span>│       ├── __init__.py</span></span>
<span class="line"><span>│       └── router.py      # 路由统一注册</span></span>
<span class="line"><span>│</span></span>
<span class="line"><span>├── tests/                 # 测试目录</span></span>
<span class="line"><span>│   ├── __init__.py</span></span>
<span class="line"><span>│   ├── conftest.py</span></span>
<span class="line"><span>│   └── modules/           # 按模块组织测试</span></span>
<span class="line"><span>│       ├── user/</span></span>
<span class="line"><span>│       └── project/</span></span>
<span class="line"><span>│</span></span>
<span class="line"><span>└── scripts/               # 脚本目录</span></span>
<span class="line"><span>    └── migrations/        # 数据库迁移</span></span></code></pre></div><p><strong>特点：</strong></p><ul><li>✅ <strong>模块边界清晰</strong>：相关代码集中，易于理解业务逻辑</li><li>✅ <strong>支持并行协作</strong>：不同模块可并行开发，减少冲突</li><li>✅ <strong>便于模块拆分</strong>：模块自包含，可独立部署</li><li>✅ <strong>可扩展性强</strong>：新模块按相同结构添加，结构清晰</li></ul><p><strong>适用场景：</strong></p><ul><li>中大型项目（&gt; 10 个 API 端点）</li><li>多人团队协作（3+ 人）</li><li>业务领域清晰，模块边界明确</li><li>需要模块独立部署或复用</li></ul><p><strong>局限性：</strong></p><ul><li>❌ 认知负担增加：需要理解&quot;共享 vs 模块特定&quot;的划分</li><li>❌ 路径变长：<code>app/modules/user/services.py</code></li><li>❌ 可能重复：模块间可能有相似代码</li><li>❌ 决策成本：需要判断代码放在共享层还是模块内</li></ul><h4 id="渐进式演进路径" tabindex="-1">渐进式演进路径 <a class="header-anchor" href="#渐进式演进路径" aria-label="Permalink to &quot;渐进式演进路径&quot;">​</a></h4><p>项目结构应该随着项目发展而演进，而不是一开始就采用最复杂的结构：</p>`,48)),(i(),p(r,null,{default:a(()=>[t(l,{id:"mermaid-353",class:"mermaid",graph:"flowchart%20LR%0A%20%20%20%20A%5B%E9%98%B6%E6%AE%B51%3A%20%E9%A1%B9%E7%9B%AE%E5%88%9D%E6%9C%9F%3Cbr%2F%3E%E6%89%81%E5%B9%B3%E5%8C%96%E7%BB%93%E6%9E%84%5D%20--%3E%7C%E8%A7%A6%E5%8F%91%E6%9D%A1%E4%BB%B6%7C%20B%5B%E9%98%B6%E6%AE%B52%3A%20%E9%A1%B9%E7%9B%AE%E5%A2%9E%E9%95%BF%3Cbr%2F%3E%E5%BC%95%E5%85%A5%E6%A8%A1%E5%9D%97%E5%8C%96%5D%0A%20%20%20%20B%20--%3E%7C%E8%A7%A6%E5%8F%91%E6%9D%A1%E4%BB%B6%7C%20C%5B%E9%98%B6%E6%AE%B53%3A%20%E9%A1%B9%E7%9B%AE%E6%88%90%E7%86%9F%3Cbr%2F%3E%E5%AE%8C%E6%95%B4%E6%B7%B7%E5%90%88%E6%A8%A1%E5%BC%8F%5D%0A%20%20%20%20%0A%20%20%20%20A1%5BAPI%E7%AB%AF%E7%82%B9%20%3C%2010%3Cbr%2F%3E%E5%9B%A2%E9%98%9F%201-2%20%E4%BA%BA%3Cbr%2F%3E%E5%8A%9F%E8%83%BD%E7%AE%80%E5%8D%95%5D%20-.-%3E%20A%0A%20%20%20%20B1%5B%E4%BB%A3%E7%A0%81%E9%87%8F%20%3E%201000%20%E8%A1%8C%3Cbr%2F%3E%E5%9B%A2%E9%98%9F%20%3E%203%20%E4%BA%BA%3Cbr%2F%3E%E6%A8%A1%E5%9D%97%E8%BE%B9%E7%95%8C%E6%B8%85%E6%99%B0%5D%20-.-%3E%20B%0A%20%20%20%20C1%5BAPI%E7%AB%AF%E7%82%B9%20%3E%2030%3Cbr%2F%3E%E6%A8%A1%E5%9D%97%E6%95%B0%20%3E%205%3Cbr%2F%3E%E9%9C%80%E8%A6%81%E7%8B%AC%E7%AB%8B%E9%83%A8%E7%BD%B2%5D%20-.-%3E%20C%0A%20%20%20%20%0A%20%20%20%20style%20A%20fill%3A%23e1f5ff%0A%20%20%20%20style%20B%20fill%3A%23fff4e1%0A%20%20%20%20style%20C%20fill%3A%23e8f5e9%0A"})]),fallback:a(()=>[...s[0]||(s[0]=[n(" Loading... ",-1)])]),_:1})),s[8]||(s[8]=e('<p><strong>阶段 1：项目初期（扁平化结构）</strong></p><ul><li><strong>适用条件</strong>：API 端点 &lt; 10，团队规模 1-2 人，功能相对简单</li><li><strong>结构</strong>：扁平化结构（模式一），按技术层次组织</li></ul><p><strong>阶段 2：项目增长（引入模块化）</strong></p><ul><li><strong>触发条件</strong>：某个功能代码量 &gt; 1000 行，团队规模 &gt; 3 人，出现明显的业务模块边界</li><li><strong>结构</strong>：开始模块化，共享代码仍在全局目录，业务代码按模块组织</li></ul><p><strong>阶段 3：项目成熟（完整混合模式）</strong></p><ul><li><strong>触发条件</strong>：API 端点 &gt; 30，模块数 &gt; 5，需要模块独立部署</li><li><strong>结构</strong>：完整混合模式（模式二），core/shared/modules 三层结构</li></ul><h4 id="决策树-如何选择设计模式" tabindex="-1">决策树：如何选择设计模式？ <a class="header-anchor" href="#决策树-如何选择设计模式" aria-label="Permalink to &quot;决策树：如何选择设计模式？&quot;">​</a></h4>',7)),(i(),p(r,null,{default:a(()=>[t(l,{id:"mermaid-402",class:"mermaid",graph:"flowchart%20TD%0A%20%20%20%20A%5B%E6%96%B0%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%A7%8B%5D%20--%3E%20B%7BAPI%E7%AB%AF%E7%82%B9%20%3C%2010%3Cbr%2F%3E%E4%B8%94%3Cbr%2F%3E%E5%9B%A2%E9%98%9F%20%3C%203%20%E4%BA%BA%3F%7D%0A%20%20%20%20B%20--%3E%7C%E6%98%AF%7C%20C%5B%E4%BD%BF%E7%94%A8%E6%89%81%E5%B9%B3%E5%8C%96%E7%BB%93%E6%9E%84%3Cbr%2F%3E%E6%A8%A1%E5%BC%8F%E4%B8%80%5D%0A%20%20%20%20B%20--%3E%7C%E5%90%A6%7C%20D%7B%E4%B8%9A%E5%8A%A1%E9%A2%86%E5%9F%9F%3Cbr%2F%3E%E6%98%AF%E5%90%A6%E6%B8%85%E6%99%B0%3F%7D%0A%20%20%20%20D%20--%3E%7C%E6%98%AF%7C%20E%5B%E4%BD%BF%E7%94%A8%E6%B7%B7%E5%90%88%E6%A8%A1%E5%BC%8F%3Cbr%2F%3E%E6%A8%A1%E5%BC%8F%E4%BA%8C%5D%0A%20%20%20%20D%20--%3E%7C%E5%90%A6%7C%20F%5B%E4%BD%BF%E7%94%A8%E6%89%81%E5%B9%B3%E5%8C%96%E7%BB%93%E6%9E%84%3Cbr%2F%3E%E5%90%8E%E7%BB%AD%E6%BC%94%E8%BF%9B%5D%0A%20%20%20%20A%20--%3E%20G%7B%E6%98%AF%E5%90%A6%E9%9C%80%E8%A6%81%3Cbr%2F%3E%E6%A8%A1%E5%9D%97%E7%8B%AC%E7%AB%8B%E9%83%A8%E7%BD%B2%3F%7D%0A%20%20%20%20G%20--%3E%7C%E6%98%AF%7C%20E%0A%20%20%20%20G%20--%3E%7C%E5%90%A6%7C%20H%7B%E6%A0%B9%E6%8D%AE%E5%9B%A2%E9%98%9F%E8%A7%84%E6%A8%A1%E9%80%89%E6%8B%A9%7D%0A%20%20%20%20H%20--%3E%7C%E5%9B%A2%E9%98%9F%20%3C%203%20%E4%BA%BA%7C%20C%0A%20%20%20%20H%20--%3E%7C%E5%9B%A2%E9%98%9F%20%E2%89%A5%203%20%E4%BA%BA%7C%20E%0A%20%20%20%20%0A%20%20%20%20style%20C%20fill%3A%23e1f5ff%0A%20%20%20%20style%20E%20fill%3A%23e8f5e9%0A%20%20%20%20style%20F%20fill%3A%23fff4e1%0A"})]),fallback:a(()=>[...s[1]||(s[1]=[n(" Loading... ",-1)])]),_:1})),s[9]||(s[9]=o("h4",{id:"代码放置决策树",tabindex:"-1"},[n("代码放置决策树 "),o("a",{class:"header-anchor",href:"#代码放置决策树","aria-label":'Permalink to "代码放置决策树"'},"​")],-1)),(i(),p(r,null,{default:a(()=>[t(l,{id:"mermaid-406",class:"mermaid",graph:"flowchart%20TD%0A%20%20%20%20A%5B%E6%96%B0%E4%BB%A3%E7%A0%81%E5%BA%94%E8%AF%A5%E6%94%BE%E5%9C%A8%E5%93%AA%E9%87%8C%3F%5D%20--%3E%20B%7B%E6%98%AF%E5%90%A6%E8%A2%AB%203%2B%20%E4%B8%AA%3Cbr%2F%3E%E6%A8%A1%E5%9D%97%E4%BD%BF%E7%94%A8%3F%7D%0A%20%20%20%20B%20--%3E%7C%E6%98%AF%7C%20C%7B%E6%98%AF%E5%90%A6%E6%98%AF%E5%9F%BA%E7%A1%80%E8%AE%BE%E6%96%BD%3F%3Cbr%2F%3E%E6%95%B0%E6%8D%AE%E5%BA%93%E3%80%81%E5%B7%A5%E5%85%B7%E5%87%BD%E6%95%B0%E3%80%81%E9%80%9A%E7%94%A8%E7%B1%BB%E5%9E%8B%7D%0A%20%20%20%20C%20--%3E%7C%E6%98%AF%7C%20D%5Bcore%2F%3Cbr%2F%3E%E6%A0%B8%E5%BF%83%E5%9F%BA%E7%A1%80%E8%AE%BE%E6%96%BD%E5%B1%82%5D%0A%20%20%20%20C%20--%3E%7C%E5%90%A6%7C%20E%5Bshared%2F%3Cbr%2F%3E%E5%85%B1%E4%BA%AB%E6%9C%8D%E5%8A%A1%E5%B1%82%5D%0A%20%20%20%20B%20--%3E%7C%E5%90%A6%7C%20F%7B%E6%98%AF%E5%90%A6%E5%B1%9E%E4%BA%8E%3Cbr%2F%3E%E6%9F%90%E4%B8%AA%E4%B8%9A%E5%8A%A1%E6%A8%A1%E5%9D%97%3F%7D%0A%20%20%20%20F%20--%3E%7C%E6%98%AF%7C%20G%5B%22modules%2F%5Bmodule%5D%2F%3Cbr%2F%3E%E4%B8%9A%E5%8A%A1%E6%A8%A1%E5%9D%97%E5%B1%82%22%5D%0A%20%20%20%20F%20--%3E%7C%E5%90%A6%7C%20E%0A%20%20%20%20%0A%20%20%20%20style%20D%20fill%3A%23e1f5ff%0A%20%20%20%20style%20E%20fill%3A%23fff4e1%0A%20%20%20%20style%20G%20fill%3A%23e8f5e9%0A"})]),fallback:a(()=>[...s[2]||(s[2]=[n(" Loading... ",-1)])]),_:1})),s[10]||(s[10]=e(`<h4 id="最佳实践建议" tabindex="-1">最佳实践建议 <a class="header-anchor" href="#最佳实践建议" aria-label="Permalink to &quot;最佳实践建议&quot;">​</a></h4><ol><li><strong>不要过度设计</strong>：项目初期保持简单，使用扁平化结构</li><li><strong>及时重构</strong>：当结构成为瓶颈时（文件难以定位、协作冲突增多），及时调整</li><li><strong>保持一致性</strong>：一旦选择某种结构，全项目保持一致</li><li><strong>文档先行</strong>：为结构划分建立清晰的文档和规范，特别是&quot;共享 vs 模块特定&quot;的划分标准</li></ol><h4 id="约定优于配置" tabindex="-1">约定优于配置 <a class="header-anchor" href="#约定优于配置" aria-label="Permalink to &quot;约定优于配置&quot;">​</a></h4><p>建立清晰的命名和结构约定，减少配置和决策成本。</p><p><strong>约定示例：</strong></p><ul><li>所有路由文件以 <code>routers.py</code> 命名</li><li>所有服务文件以 <code>services.py</code> 命名</li><li>所有仓储文件以 <code>repositories.py</code> 命名</li><li>统一使用 <code>__init__.py</code> 作为模块入口</li></ul><h4 id="一致性原则" tabindex="-1">一致性原则 <a class="header-anchor" href="#一致性原则" aria-label="Permalink to &quot;一致性原则&quot;">​</a></h4><p>在整个项目中保持结构、命名、编码风格的一致性。</p><p><strong>一致性体现在：</strong></p><ul><li>目录结构模式一致</li><li>文件命名规范一致</li><li>代码组织方式一致</li><li>导入导出方式一致</li></ul><h2 id="二、标准目录结构设计" tabindex="-1">二、标准目录结构设计 <a class="header-anchor" href="#二、标准目录结构设计" aria-label="Permalink to &quot;二、标准目录结构设计&quot;">​</a></h2><h3 id="_2-1-根目录结构" tabindex="-1">2.1 根目录结构 <a class="header-anchor" href="#_2-1-根目录结构" aria-label="Permalink to &quot;2.1 根目录结构&quot;">​</a></h3><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>backend/</span></span>
<span class="line"><span>├── app/                    # 应用主目录</span></span>
<span class="line"><span>├── tests/                  # 测试目录</span></span>
<span class="line"><span>├── scripts/               # 脚本目录</span></span>
<span class="line"><span>├── docs/                  # 文档目录</span></span>
<span class="line"><span>├── .env                   # 环境变量配置</span></span>
<span class="line"><span>├── .env.example           # 环境变量示例</span></span>
<span class="line"><span>├── .gitignore             # Git 忽略配置</span></span>
<span class="line"><span>├── pyproject.toml         # 项目配置和依赖（使用 uv 管理）</span></span>
<span class="line"><span>├── uv.lock                # 锁定的依赖版本（使用 uv 生成）</span></span>
<span class="line"><span>├── Dockerfile             # 容器化配置</span></span>
<span class="line"><span>├── docker-compose.yml     # Docker Compose 配置</span></span>
<span class="line"><span>├── README.md              # 项目文档</span></span>
<span class="line"><span>└── main.py                # 应用入口文件</span></span></code></pre></div><h3 id="_2-2-app-核心目录架构" tabindex="-1">2.2 app/ 核心目录架构 <a class="header-anchor" href="#_2-2-app-核心目录架构" aria-label="Permalink to &quot;2.2 app/ 核心目录架构&quot;">​</a></h3><h4 id="_2-2-1-入口与配置层" tabindex="-1">2.2.1 入口与配置层 <a class="header-anchor" href="#_2-2-1-入口与配置层" aria-label="Permalink to &quot;2.2.1 入口与配置层&quot;">​</a></h4><p><strong>职责：</strong> 应用的启动入口和全局配置</p><p><strong>文件说明：</strong></p><ul><li><p><code>main.py</code> - 应用入口文件</p><ul><li>创建 FastAPI 应用实例</li><li>注册中间件、异常处理器</li><li>注册路由</li><li>配置生命周期管理</li></ul></li><li><p><code>config.py</code> - 配置管理</p><ul><li>基于 Pydantic Settings 的环境变量管理</li><li>类型安全的配置类</li><li>配置验证和默认值</li></ul></li></ul><h4 id="_2-2-2-api-路由层-routers" tabindex="-1">2.2.2 API 路由层（Routers） <a class="header-anchor" href="#_2-2-2-api-路由层-routers" aria-label="Permalink to &quot;2.2.2 API 路由层（Routers）&quot;">​</a></h4><p><strong>职责：</strong> 定义 API 端点，处理 HTTP 请求和响应</p><p><strong>设计原则：</strong></p><ul><li>路由只负责接收请求和返回响应</li><li>业务逻辑委托给服务层处理</li><li>使用依赖注入获取服务和数据库会话</li><li>统一使用响应模型格式化输出</li></ul><p><strong>目录结构：</strong></p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>api/</span></span>
<span class="line"><span>├── __init__.py</span></span>
<span class="line"><span>└── router.py              # API 路由统一注册器</span></span></code></pre></div><p><strong>设计要点：</strong></p><ul><li><code>router.py</code> 负责聚合所有业务模块的路由</li><li>使用 <code>APIRouter</code> 组织路由</li><li>统一路由前缀和标签</li><li>延迟导入模块，避免循环依赖</li></ul><h4 id="_2-2-3-核心基础设施层-core" tabindex="-1">2.2.3 核心基础设施层（Core） <a class="header-anchor" href="#_2-2-3-核心基础设施层-core" aria-label="Permalink to &quot;2.2.3 核心基础设施层（Core）&quot;">​</a></h4><p><strong>职责：</strong> 提供应用的核心基础设施功能</p><p><strong>目录结构：</strong></p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>core/</span></span>
<span class="line"><span>├── __init__.py</span></span>
<span class="line"><span>├── config.py              # 配置管理（如果不在根目录）</span></span>
<span class="line"><span>├── exceptions/            # 异常定义</span></span>
<span class="line"><span>│   ├── __init__.py</span></span>
<span class="line"><span>│   ├── base.py           # 基础异常类</span></span>
<span class="line"><span>│   ├── handlers.py       # 全局异常处理器</span></span>
<span class="line"><span>│   └── [module]_error.py # 模块特定异常</span></span>
<span class="line"><span>├── response.py            # 响应模型和工具函数</span></span>
<span class="line"><span>├── schemas.py             # 通用 Pydantic 模式</span></span>
<span class="line"><span>├── security/              # 安全认证</span></span>
<span class="line"><span>│   ├── __init__.py</span></span>
<span class="line"><span>│   ├── dependencies.py   # 认证依赖注入</span></span>
<span class="line"><span>│   ├── jwt_handler.py    # JWT 处理</span></span>
<span class="line"><span>│   └── schemas.py        # 安全相关模式</span></span>
<span class="line"><span>├── middleware/            # 中间件</span></span>
<span class="line"><span>│   └── [middleware].py</span></span>
<span class="line"><span>└── policies/              # 策略模式</span></span>
<span class="line"><span>    └── [policy].py</span></span></code></pre></div><p><strong>设计要点：</strong></p><ul><li><code>exceptions/</code> 目录统一管理所有异常定义</li><li><code>handlers.py</code> 注册全局异常处理器</li><li><code>response.py</code> 提供统一的响应格式</li><li><code>security/</code> 目录封装认证和授权逻辑</li></ul><h4 id="_2-2-4-数据库层-database" tabindex="-1">2.2.4 数据库层（Database） <a class="header-anchor" href="#_2-2-4-数据库层-database" aria-label="Permalink to &quot;2.2.4 数据库层（Database）&quot;">​</a></h4><p><strong>职责：</strong> 管理数据库连接、模型定义和数据访问</p><p><strong>目录结构：</strong></p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>db/</span></span>
<span class="line"><span>├── __init__.py</span></span>
<span class="line"><span>├── base.py                # SQLAlchemy 基础模型类</span></span>
<span class="line"><span>├── connection.py          # 数据库连接和会话管理</span></span>
<span class="line"><span>├── models/                # 数据模型（如果使用扁平化结构）</span></span>
<span class="line"><span>│   ├── __init__.py</span></span>
<span class="line"><span>│   ├── user.py</span></span>
<span class="line"><span>│   └── project.py</span></span>
<span class="line"><span>└── repositories/          # 基础仓储类（如果使用混合模式）</span></span>
<span class="line"><span>    └── base.py            # 基础仓储抽象类</span></span></code></pre></div><p><strong>设计要点：</strong></p><ul><li><code>base.py</code> 定义 SQLAlchemy 基础模型类</li><li><code>connection.py</code> 管理数据库连接池和会话工厂</li><li>使用异步 SQLAlchemy（AsyncSession）</li><li>仓储模式抽象数据访问逻辑</li></ul><h4 id="_2-2-5-业务模块层-modules" tabindex="-1">2.2.5 业务模块层（Modules） <a class="header-anchor" href="#_2-2-5-业务模块层-modules" aria-label="Permalink to &quot;2.2.5 业务模块层（Modules）&quot;">​</a></h4><p><strong>职责：</strong> 实现具体的业务功能</p><p><strong>设计原则：</strong></p><ul><li>按业务领域划分模块</li><li>每个模块包含完整的分层结构</li><li>模块间通过共享服务层通信</li><li>避免模块间的直接依赖</li></ul><p><strong>目录结构（完整模块）：</strong></p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>modules/</span></span>
<span class="line"><span>├── __init__.py</span></span>
<span class="line"><span>│</span></span>
<span class="line"><span>├── user/                  # 用户模块</span></span>
<span class="line"><span>│   ├── __init__.py</span></span>
<span class="line"><span>│   ├── models.py          # 数据模型</span></span>
<span class="line"><span>│   ├── schemas.py         # Pydantic 模式（请求/响应）</span></span>
<span class="line"><span>│   ├── repositories.py    # 数据访问层</span></span>
<span class="line"><span>│   ├── services.py        # 业务逻辑层</span></span>
<span class="line"><span>│   ├── routers.py         # API 路由层</span></span>
<span class="line"><span>│   └── dependencies.py    # 模块依赖注入</span></span>
<span class="line"><span>│</span></span>
<span class="line"><span>└── [module]/              # 其他业务模块</span></span></code></pre></div><p><strong>设计要点：</strong></p><ul><li>每个模块包含完整的分层结构</li><li><code>models.py</code> 定义 SQLAlchemy 数据模型</li><li><code>schemas.py</code> 定义 Pydantic 请求/响应模式</li><li><code>repositories.py</code> 封装数据访问操作</li><li><code>services.py</code> 实现业务逻辑</li><li><code>routers.py</code> 定义 API 端点</li><li><code>dependencies.py</code> 提供模块特定的依赖注入</li></ul><h4 id="_2-2-6-共享服务层-shared" tabindex="-1">2.2.6 共享服务层（Shared） <a class="header-anchor" href="#_2-2-6-共享服务层-shared" aria-label="Permalink to &quot;2.2.6 共享服务层（Shared）&quot;">​</a></h4><p><strong>职责：</strong> 提供跨模块共享的服务和工具</p><p><strong>目录结构：</strong></p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>shared/</span></span>
<span class="line"><span>├── __init__.py</span></span>
<span class="line"><span>├── storage/               # 存储服务</span></span>
<span class="line"><span>│   ├── __init__.py</span></span>
<span class="line"><span>│   └── minio_service.py   # MinIO 对象存储服务</span></span>
<span class="line"><span>├── cache/                 # 缓存服务</span></span>
<span class="line"><span>│   └── redis_service.py</span></span>
<span class="line"><span>├── messaging/             # 消息服务</span></span>
<span class="line"><span>│   └── rabbitmq_service.py</span></span>
<span class="line"><span>├── monitoring/            # 监控服务</span></span>
<span class="line"><span>│   └── logging_service.py</span></span>
<span class="line"><span>└── utils/                 # 共享工具函数</span></span>
<span class="line"><span>    ├── format.py</span></span>
<span class="line"><span>    └── validation.py</span></span></code></pre></div><p><strong>设计要点：</strong></p><ul><li>跨模块使用的服务放在 <code>shared/</code> 目录</li><li>按服务类型组织子目录</li><li>提供统一的接口和依赖注入</li></ul><h4 id="_2-2-7-工具函数层-utils" tabindex="-1">2.2.7 工具函数层（Utils） <a class="header-anchor" href="#_2-2-7-工具函数层-utils" aria-label="Permalink to &quot;2.2.7 工具函数层（Utils）&quot;">​</a></h4><p><strong>职责：</strong> 提供纯函数工具，不依赖业务逻辑</p><p><strong>设计原则：</strong></p><ul><li>纯函数，无副作用</li><li>按功能分类组织</li><li>充分使用类型提示</li><li>编写单元测试</li></ul><p><strong>目录结构：</strong></p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>utils/</span></span>
<span class="line"><span>├── __init__.py</span></span>
<span class="line"><span>├── format.py              # 格式化工具（日期、数字等）</span></span>
<span class="line"><span>├── validation.py          # 验证工具（邮箱、手机号等）</span></span>
<span class="line"><span>├── encryption.py          # 加密工具</span></span>
<span class="line"><span>└── [category].py          # 其他类别工具</span></span></code></pre></div><p><strong>设计要点：</strong></p><ul><li>纯函数，不依赖数据库或外部服务</li><li>按功能分类组织，便于查找和使用</li><li>使用类型提示，确保类型安全</li></ul><h2 id="三、模块化设计模式" tabindex="-1">三、模块化设计模式 <a class="header-anchor" href="#三、模块化设计模式" aria-label="Permalink to &quot;三、模块化设计模式&quot;">​</a></h2><h3 id="_3-1-混合模式详解-推荐用于中大型项目" tabindex="-1">3.1 混合模式详解（推荐用于中大型项目） <a class="header-anchor" href="#_3-1-混合模式详解-推荐用于中大型项目" aria-label="Permalink to &quot;3.1 混合模式详解（推荐用于中大型项目）&quot;">​</a></h3><p>混合模式是结合技术层次和功能领域的最佳实践，通过 <code>core/</code>、<code>shared/</code>、<code>modules/</code> 三层结构实现清晰的职责划分。</p><h4 id="三层结构说明" tabindex="-1">三层结构说明 <a class="header-anchor" href="#三层结构说明" aria-label="Permalink to &quot;三层结构说明&quot;">​</a></h4>`,64)),(i(),p(r,null,{default:a(()=>[t(l,{id:"mermaid-866",class:"mermaid",graph:"graph%20TB%0A%20%20%20%20subgraph%20Core%5B%22core%2F%20%E6%A0%B8%E5%BF%83%E5%9F%BA%E7%A1%80%E8%AE%BE%E6%96%BD%E5%B1%82%22%5D%0A%20%20%20%20%20%20%20%20direction%20TB%0A%20%20%20%20%20%20%20%20C1%5B%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86%5D%0A%20%20%20%20%20%20%20%20C2%5B%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86%5D%0A%20%20%20%20%20%20%20%20C3%5B%E5%93%8D%E5%BA%94%E6%A8%A1%E5%9E%8B%5D%0A%20%20%20%20%20%20%20%20C4%5B%E5%AE%89%E5%85%A8%E8%AE%A4%E8%AF%81%5D%0A%20%20%20%20%20%20%20%20C5%5B%E4%B8%AD%E9%97%B4%E4%BB%B6%5D%0A%20%20%20%20end%0A%20%20%20%20%0A%20%20%20%20subgraph%20Shared%5B%22shared%2F%20%E5%85%B1%E4%BA%AB%E6%9C%8D%E5%8A%A1%E5%B1%82%22%5D%0A%20%20%20%20%20%20%20%20direction%20TB%0A%20%20%20%20%20%20%20%20S1%5B%E5%AD%98%E5%82%A8%E6%9C%8D%E5%8A%A1%5D%0A%20%20%20%20%20%20%20%20S2%5B%E7%BC%93%E5%AD%98%E6%9C%8D%E5%8A%A1%5D%0A%20%20%20%20%20%20%20%20S3%5B%E6%B6%88%E6%81%AF%E6%9C%8D%E5%8A%A1%5D%0A%20%20%20%20%20%20%20%20S4%5B%E7%9B%91%E6%8E%A7%E6%9C%8D%E5%8A%A1%5D%0A%20%20%20%20%20%20%20%20S5%5B%E5%85%B1%E4%BA%AB%E5%B7%A5%E5%85%B7%5D%0A%20%20%20%20end%0A%20%20%20%20%0A%20%20%20%20subgraph%20Modules%5B%22modules%2F%20%E4%B8%9A%E5%8A%A1%E6%A8%A1%E5%9D%97%E5%B1%82%22%5D%0A%20%20%20%20%20%20%20%20direction%20TB%0A%20%20%20%20%20%20%20%20M1%5Buser%20%E6%A8%A1%E5%9D%97%5D%0A%20%20%20%20%20%20%20%20M2%5Bproject%20%E6%A8%A1%E5%9D%97%5D%0A%20%20%20%20%20%20%20%20M3%5B%E5%85%B6%E4%BB%96%E6%A8%A1%E5%9D%97%5D%0A%20%20%20%20end%0A%20%20%20%20%0A%20%20%20%20Shared%20-.-%3E%7C%E4%BE%9D%E8%B5%96%7C%20Core%0A%20%20%20%20Modules%20-.-%3E%7C%E4%BE%9D%E8%B5%96%7C%20Core%0A%20%20%20%20Modules%20-.-%3E%7C%E4%BE%9D%E8%B5%96%7C%20Shared%0A%20%20%20%20%0A%20%20%20%20style%20Core%20fill%3A%23e1f5ff%2Cstroke%3A%231976d2%2Cstroke-width%3A2px%0A%20%20%20%20style%20Shared%20fill%3A%23fff4e1%2Cstroke%3A%23f57c00%2Cstroke-width%3A2px%0A%20%20%20%20style%20Modules%20fill%3A%23e8f5e9%2Cstroke%3A%23388e3c%2Cstroke-width%3A2px%0A"})]),fallback:a(()=>[...s[3]||(s[3]=[n(" Loading... ",-1)])]),_:1})),s[11]||(s[11]=e(`<p><strong>1. core/ - 核心基础设施层</strong></p><ul><li><strong>职责</strong>：纯技术基础设施，不包含任何业务逻辑</li><li><strong>内容</strong>：配置管理、异常处理、响应模型、安全认证、中间件</li><li><strong>特点</strong>：被所有模块依赖，但不依赖任何业务模块</li><li><strong>判断标准</strong>：是否与业务无关，是否被所有模块使用</li></ul><p><strong>2. shared/ - 共享服务层</strong></p><ul><li><strong>职责</strong>：跨模块共享的服务和工具</li><li><strong>内容</strong>：存储服务、缓存服务、消息服务、监控服务、共享工具函数</li><li><strong>特点</strong>：包含业务逻辑，但被多个模块使用</li><li><strong>判断标准</strong>：是否被 3+ 个模块使用，是否包含业务逻辑</li></ul><p><strong>3. modules/ - 业务模块层</strong></p><ul><li><strong>职责</strong>：特定业务领域的完整实现</li><li><strong>内容</strong>：模块特定的模型、模式、仓储、服务、路由</li><li><strong>特点</strong>：模块自包含，可独立开发和部署</li><li><strong>判断标准</strong>：是否只属于某个业务领域</li></ul><h4 id="完整混合模式结构示例" tabindex="-1">完整混合模式结构示例 <a class="header-anchor" href="#完整混合模式结构示例" aria-label="Permalink to &quot;完整混合模式结构示例&quot;">​</a></h4><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>app/</span></span>
<span class="line"><span>├── core/                   # 核心基础设施</span></span>
<span class="line"><span>│   ├── config.py          # 配置管理</span></span>
<span class="line"><span>│   ├── exceptions/        # 异常定义和处理</span></span>
<span class="line"><span>│   │   ├── base.py</span></span>
<span class="line"><span>│   │   └── handlers.py</span></span>
<span class="line"><span>│   ├── response.py        # 响应模型</span></span>
<span class="line"><span>│   ├── schemas.py         # 通用模式</span></span>
<span class="line"><span>│   ├── security/          # 安全认证</span></span>
<span class="line"><span>│   │   ├── dependencies.py</span></span>
<span class="line"><span>│   │   └── jwt_handler.py</span></span>
<span class="line"><span>│   └── middleware/        # 中间件</span></span>
<span class="line"><span>│</span></span>
<span class="line"><span>├── db/                    # 数据库层</span></span>
<span class="line"><span>│   ├── base.py           # 基础模型类</span></span>
<span class="line"><span>│   ├── connection.py     # 数据库连接</span></span>
<span class="line"><span>│   └── repositories/     # 基础仓储类</span></span>
<span class="line"><span>│       └── base.py</span></span>
<span class="line"><span>│</span></span>
<span class="line"><span>├── shared/                # 共享服务</span></span>
<span class="line"><span>│   ├── storage/          # 存储服务</span></span>
<span class="line"><span>│   ├── cache/            # 缓存服务</span></span>
<span class="line"><span>│   ├── messaging/        # 消息服务</span></span>
<span class="line"><span>│   └── utils/            # 共享工具</span></span>
<span class="line"><span>│</span></span>
<span class="line"><span>├── modules/               # 业务模块</span></span>
<span class="line"><span>│   ├── user/             # 用户模块</span></span>
<span class="line"><span>│   │   ├── models.py</span></span>
<span class="line"><span>│   │   ├── schemas.py</span></span>
<span class="line"><span>│   │   ├── repositories.py</span></span>
<span class="line"><span>│   │   ├── services.py</span></span>
<span class="line"><span>│   │   ├── routers.py</span></span>
<span class="line"><span>│   │   └── dependencies.py</span></span>
<span class="line"><span>│   │</span></span>
<span class="line"><span>│   └── project/          # 项目模块</span></span>
<span class="line"><span>│       ├── models.py</span></span>
<span class="line"><span>│       ├── schemas.py</span></span>
<span class="line"><span>│       ├── repositories.py</span></span>
<span class="line"><span>│       ├── services.py</span></span>
<span class="line"><span>│       ├── routers.py</span></span>
<span class="line"><span>│       └── dependencies.py</span></span>
<span class="line"><span>│</span></span>
<span class="line"><span>└── api/                   # API 统一注册</span></span>
<span class="line"><span>    └── router.py</span></span></code></pre></div><h4 id="划分标准详解" tabindex="-1">划分标准详解 <a class="header-anchor" href="#划分标准详解" aria-label="Permalink to &quot;划分标准详解&quot;">​</a></h4><p><strong>core/ 的判断标准：</strong></p><ul><li>✅ 配置管理（环境变量、应用配置）</li><li>✅ 异常定义和全局异常处理器</li><li>✅ 统一响应模型和工具函数</li><li>✅ 安全认证和授权逻辑</li><li>✅ 中间件（日志、CORS 等）</li><li>❌ 不包含任何业务逻辑</li><li>❌ 不依赖任何业务模块</li></ul><p><strong>shared/ 的判断标准：</strong></p><ul><li>✅ 被 3+ 个模块使用的服务（存储、缓存、消息等）</li><li>✅ 跨模块的工具函数</li><li>✅ 共享的监控和日志服务</li><li>❌ 只被 1-2 个模块使用的代码（应放在模块内）</li></ul><p><strong>modules/ 的判断标准：</strong></p><ul><li>✅ 只属于某个业务领域的代码</li><li>✅ 模块特定的模型、服务、路由</li><li>✅ 模块可能独立部署或复用</li><li>❌ 被多个模块使用的代码（应放在 shared/）</li></ul><h3 id="_3-2-功能模块划分策略" tabindex="-1">3.2 功能模块划分策略 <a class="header-anchor" href="#_3-2-功能模块划分策略" aria-label="Permalink to &quot;3.2 功能模块划分策略&quot;">​</a></h3><h4 id="按业务领域划分-domain-driven" tabindex="-1">按业务领域划分（Domain-Driven） <a class="header-anchor" href="#按业务领域划分-domain-driven" aria-label="Permalink to &quot;按业务领域划分（Domain-Driven）&quot;">​</a></h4><p>以业务领域为核心，将相关的功能组织在一起。</p><p><strong>适用场景：</strong></p><ul><li>中大型项目</li><li>业务领域清晰</li><li>团队按领域分工</li></ul><p><strong>示例：</strong></p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>modules/</span></span>
<span class="line"><span>├── user-management/    # 用户管理领域</span></span>
<span class="line"><span>├── project-management/ # 项目管理领域</span></span>
<span class="line"><span>└── workflow/           # 工作流领域</span></span></code></pre></div><h4 id="按功能特性划分-feature-based" tabindex="-1">按功能特性划分（Feature-Based） <a class="header-anchor" href="#按功能特性划分-feature-based" aria-label="Permalink to &quot;按功能特性划分（Feature-Based）&quot;">​</a></h4><p>以功能特性为核心，将实现某个完整功能的所有代码组织在一起。</p><p><strong>适用场景：</strong></p><ul><li>功能边界清晰</li><li>功能相对独立</li><li>便于功能模块的复用</li></ul><p><strong>示例：</strong></p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>modules/</span></span>
<span class="line"><span>├── authentication/     # 认证功能</span></span>
<span class="line"><span>├── file-upload/        # 文件上传功能</span></span>
<span class="line"><span>└── data-export/        # 数据导出功能</span></span></code></pre></div><h3 id="_3-3-模块内部结构" tabindex="-1">3.3 模块内部结构 <a class="header-anchor" href="#_3-3-模块内部结构" aria-label="Permalink to &quot;3.3 模块内部结构&quot;">​</a></h3><h4 id="完整模块结构-适用于大型模块" tabindex="-1">完整模块结构（适用于大型模块） <a class="header-anchor" href="#完整模块结构-适用于大型模块" aria-label="Permalink to &quot;完整模块结构（适用于大型模块）&quot;">​</a></h4><p><strong>目录结构：</strong></p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>modules/user/</span></span>
<span class="line"><span>├── __init__.py</span></span>
<span class="line"><span>├── models.py          # 数据模型（SQLAlchemy）</span></span>
<span class="line"><span>├── schemas.py         # Pydantic 模式（请求/响应）</span></span>
<span class="line"><span>├── repositories.py    # 数据访问层</span></span>
<span class="line"><span>├── services.py        # 业务逻辑层</span></span>
<span class="line"><span>├── routers.py         # API 路由层</span></span>
<span class="line"><span>└── dependencies.py    # 依赖注入</span></span></code></pre></div><p><strong>特点：</strong></p><ul><li>模块完全自包含</li><li>便于模块独立开发和测试</li><li>便于模块独立部署或复用</li><li>适合大型模块（代码量 &gt; 1000 行）</li></ul><h4 id="简化模块结构-适用于小型模块" tabindex="-1">简化模块结构（适用于小型模块） <a class="header-anchor" href="#简化模块结构-适用于小型模块" aria-label="Permalink to &quot;简化模块结构（适用于小型模块）&quot;">​</a></h4><p><strong>目录结构：</strong></p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>modules/user/</span></span>
<span class="line"><span>├── __init__.py</span></span>
<span class="line"><span>├── models.py</span></span>
<span class="line"><span>├── schemas.py</span></span>
<span class="line"><span>├── routers.py         # 路由中直接包含业务逻辑（简单场景）</span></span>
<span class="line"><span>└── dependencies.py</span></span></code></pre></div><p><strong>特点：</strong></p><ul><li>结构简单，易于维护</li><li>共享代码放在 <code>shared/</code> 或 <code>core/</code></li><li>适合小型模块（代码量 &lt; 500 行）</li></ul><h4 id="选择建议" tabindex="-1">选择建议 <a class="header-anchor" href="#选择建议" aria-label="Permalink to &quot;选择建议&quot;">​</a></h4><p><strong>使用完整结构的情况：</strong></p><ul><li>模块代码量 &gt; 1000 行</li><li>模块可能独立部署</li><li>模块需要独立测试</li><li>模块可能被其他项目复用</li></ul><p><strong>使用简化结构的情况：</strong></p><ul><li>模块代码量 &lt; 500 行</li><li>模块功能简单</li><li>共享代码较多，放在 <code>shared/</code> 更合适</li></ul><h4 id="模块内基础文件职责说明" tabindex="-1">模块内基础文件职责说明 <a class="header-anchor" href="#模块内基础文件职责说明" aria-label="Permalink to &quot;模块内基础文件职责说明&quot;">​</a></h4><ul><li><strong><code>models.py</code></strong>：定义数据库表结构和 ORM 模型，只关心数据结构和关系映射，不包含业务逻辑。</li><li><strong><code>schemas.py</code></strong>：定义 Pydantic 模型，用于请求体验证和响应数据序列化，是 API 与内部领域模型之间的数据契约。</li><li><strong><code>repositories.py</code></strong>：封装对数据库的具体读写操作，提供类型安全的 CRUD 与查询接口，不处理业务规则。</li><li><strong><code>services.py</code></strong>：实现业务用例，协调仓储、其他服务和外部系统，是业务规则的主要承载者。</li><li><strong><code>routers.py</code></strong>：定义 HTTP 路由和入参/出参，负责协议层（HTTP ↔ 领域）的转换，不直接访问数据库。</li><li><strong><code>dependencies.py</code></strong>：定义依赖注入函数，例如获取 <code>UserService</code>、<code>AsyncSession</code>、当前用户等，是模块对外暴露的依赖装配入口。</li><li><strong><code>__init__.py</code></strong>：可选地聚合模块内对外暴露的主要类型/函数，方便其他模块通过 <code>app.modules.user</code> 等路径进行导入。</li></ul><p><strong>示例：最小模块代码结构</strong></p><div class="language-python vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># modules/user/models.py</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> User</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Base</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">TimestampMixin</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">):</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    __tablename__ </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;users&quot;</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    id</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Column(UUID(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">as_uuid</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">True</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">), </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">primary_key</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">True</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">default</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">uuid4)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    email </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Column(String, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">unique</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">True</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">nullable</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">False</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># modules/user/schemas.py</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> UserCreate</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">BaseModel</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">):</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    email: EmailStr</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> UserResponse</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">BaseModel</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">):</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    id</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">UUID</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    email: EmailStr</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># modules/user/repositories.py</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> UserRepository</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(BaseRepository[User]):</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    model </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> User</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    async</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> get_by_email</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(self, email: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">str</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) -&gt; User </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> None</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        stmt </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> select(User).where(User.email </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> email)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> self</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.scalar(stmt)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># modules/user/services.py</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> UserService</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    def</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> __init__</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(self, repo: UserRepository):</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        self</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.repo </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> repo</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    async</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> create_user</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(self, data: UserCreate) -&gt; UserResponse:</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        if</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> self</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.repo.get_by_email(data.email):</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            raise</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> UserAlreadyExistsError()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        user </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> self</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.repo.create(User(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">**</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">data.model_dump()))</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> UserResponse.model_validate(user)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># modules/user/routers.py</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">router </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> APIRouter(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">prefix</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;/users&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">tags</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;用户管理&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">])</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">@router.post</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;/&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">response_model</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">UserResponse)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">async</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> create_user</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    payload: UserCreate,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    service: UserService </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Depends(get_user_service),</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">):</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> service.create_user(payload)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># modules/user/dependencies.py</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> get_user_service</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    db: AsyncSession </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Depends(get_async_db),</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) -&gt; UserService:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    repo </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> UserRepository(db)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> UserService(repo)</span></span></code></pre></div><h3 id="_3-4-模块间依赖管理" tabindex="-1">3.4 模块间依赖管理 <a class="header-anchor" href="#_3-4-模块间依赖管理" aria-label="Permalink to &quot;3.4 模块间依赖管理&quot;">​</a></h3><h4 id="依赖方向规则" tabindex="-1">依赖方向规则 <a class="header-anchor" href="#依赖方向规则" aria-label="Permalink to &quot;依赖方向规则&quot;">​</a></h4>`,50)),(i(),p(r,null,{default:a(()=>[t(l,{id:"mermaid-1262",class:"mermaid",graph:"graph%20TD%0A%20%20%20%20subgraph%20%E4%B8%9A%E5%8A%A1%E5%B1%82%5B%22%E4%B8%9A%E5%8A%A1%E5%B1%82%EF%BC%88modules%2F%EF%BC%89%22%5D%0A%20%20%20%20%20%20%20%20direction%20TB%0A%20%20%20%20%20%20%20%20Routers%5Brouters%3Cbr%2F%3E%E8%B7%AF%E7%94%B1%E5%B1%82%5D%0A%20%20%20%20%20%20%20%20Services%5Bservices%3Cbr%2F%3E%E6%9C%8D%E5%8A%A1%E5%B1%82%5D%0A%20%20%20%20%20%20%20%20Repositories%5Brepositories%3Cbr%2F%3E%E4%BB%93%E5%82%A8%E5%B1%82%5D%0A%20%20%20%20%20%20%20%20Models%5Bmodels%3Cbr%2F%3E%E6%A8%A1%E5%9E%8B%E5%B1%82%5D%0A%20%20%20%20end%0A%20%20%20%20%0A%20%20%20%20subgraph%20%E5%85%B1%E4%BA%AB%E5%B1%82%5B%22%E5%85%B1%E4%BA%AB%E5%B1%82%EF%BC%88shared%2F%EF%BC%89%22%5D%0A%20%20%20%20%20%20%20%20direction%20TB%0A%20%20%20%20%20%20%20%20SharedServices%5Bshared%2Fservices%5D%0A%20%20%20%20%20%20%20%20SharedUtils%5Bshared%2Futils%5D%0A%20%20%20%20end%0A%20%20%20%20%0A%20%20%20%20subgraph%20%E6%A0%B8%E5%BF%83%E5%B1%82%5B%22%E6%A0%B8%E5%BF%83%E5%B1%82%EF%BC%88core%2F%EF%BC%89%22%5D%0A%20%20%20%20%20%20%20%20Core%5Bcore%2F%3Cbr%2F%3E%E6%A0%B8%E5%BF%83%E5%9F%BA%E7%A1%80%E8%AE%BE%E6%96%BD%5D%0A%20%20%20%20end%0A%20%20%20%20%0A%20%20%20%20Routers%20--%3E%20Services%0A%20%20%20%20Services%20--%3E%20Repositories%0A%20%20%20%20Repositories%20--%3E%20Models%0A%20%20%20%20Models%20--%3E%20Core%0A%20%20%20%20%0A%20%20%20%20Routers%20-.-%3E%7C%E5%8F%AF%E4%BE%9D%E8%B5%96%7C%20SharedServices%0A%20%20%20%20Services%20-.-%3E%7C%E5%8F%AF%E4%BE%9D%E8%B5%96%7C%20SharedServices%0A%20%20%20%20Services%20-.-%3E%7C%E5%8F%AF%E4%BE%9D%E8%B5%96%7C%20SharedUtils%0A%20%20%20%20SharedServices%20-.-%3E%7C%E5%8F%AF%E4%BE%9D%E8%B5%96%7C%20Core%0A%20%20%20%20%0A%20%20%20%20style%20Core%20fill%3A%23e1f5ff%2Cstroke%3A%231976d2%2Cstroke-width%3A3px%0A%20%20%20%20style%20SharedServices%20fill%3A%23fff4e1%0A%20%20%20%20style%20SharedUtils%20fill%3A%23fff4e1%0A%20%20%20%20style%20%E4%B8%9A%E5%8A%A1%E5%B1%82%20fill%3A%23e8f5e9%2Cstroke%3A%23388e3c%2Cstroke-width%3A2px%0A%20%20%20%20style%20%E5%85%B1%E4%BA%AB%E5%B1%82%20fill%3A%23fff4e1%2Cstroke%3A%23f57c00%2Cstroke-width%3A2px%0A%20%20%20%20style%20%E6%A0%B8%E5%BF%83%E5%B1%82%20fill%3A%23e1f5ff%2Cstroke%3A%231976d2%2Cstroke-width%3A2px%0A"})]),fallback:a(()=>[...s[4]||(s[4]=[n(" Loading... ",-1)])]),_:1})),s[12]||(s[12]=e('<p><strong>依赖规则：</strong></p><ol><li><strong>core/</strong> 不依赖任何其他层（最底层）</li><li><strong>shared/</strong> 只能依赖 <code>core/</code></li><li><strong>modules/</strong> 可以依赖 <code>core/</code> 和 <code>shared/</code>，但不能依赖其他 <code>modules/</code></li><li><strong>routers</strong> 不应该被其他层依赖（最顶层）</li></ol><h4 id="避免循环依赖" tabindex="-1">避免循环依赖 <a class="header-anchor" href="#避免循环依赖" aria-label="Permalink to &quot;避免循环依赖&quot;">​</a></h4>',3)),(i(),p(r,null,{default:a(()=>[t(l,{id:"mermaid-1291",class:"mermaid",graph:"graph%20LR%0A%20%20%20%20subgraph%20%E9%97%AE%E9%A2%98%5B%22%E2%9D%8C%20%E5%BE%AA%E7%8E%AF%E4%BE%9D%E8%B5%96%E9%97%AE%E9%A2%98%22%5D%0A%20%20%20%20%20%20%20%20direction%20LR%0A%20%20%20%20%20%20%20%20A%5BmoduleA%5D%20--%3E%7C%E4%BE%9D%E8%B5%96%7C%20B%5BmoduleB%5D%0A%20%20%20%20%20%20%20%20B%20--%3E%7C%E4%BE%9D%E8%B5%96%7C%20C%5BmoduleC%5D%0A%20%20%20%20%20%20%20%20C%20--%3E%7C%E4%BE%9D%E8%B5%96%7C%20A%0A%20%20%20%20end%0A%20%20%20%20%0A%20%20%20%20subgraph%20%E8%A7%A3%E5%86%B3%5B%22%E2%9C%85%20%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88%EF%BC%9A%E6%8F%90%E5%8F%96%E5%85%B1%E4%BA%AB%E4%BB%A3%E7%A0%81%22%5D%0A%20%20%20%20%20%20%20%20direction%20TB%0A%20%20%20%20%20%20%20%20D%5Bshared%2F%3Cbr%2F%3E%E5%85%B1%E4%BA%AB%E4%BB%A3%E7%A0%81%5D%0A%20%20%20%20%20%20%20%20E%5BmoduleA%5D%0A%20%20%20%20%20%20%20%20F%5BmoduleB%5D%0A%20%20%20%20%20%20%20%20G%5BmoduleC%5D%0A%20%20%20%20%20%20%20%20D%20--%3E%20E%0A%20%20%20%20%20%20%20%20D%20--%3E%20F%0A%20%20%20%20%20%20%20%20D%20--%3E%20G%0A%20%20%20%20end%0A%20%20%20%20%0A%20%20%20%20%E9%97%AE%E9%A2%98%20-.-%3E%7C%E6%8F%90%E5%8F%96%E5%85%B1%E4%BA%AB%E4%BB%A3%E7%A0%81%7C%20%E8%A7%A3%E5%86%B3%0A%20%20%20%20%0A%20%20%20%20style%20%E9%97%AE%E9%A2%98%20fill%3A%23ffebee%2Cstroke%3A%23c62828%2Cstroke-width%3A2px%0A%20%20%20%20style%20%E8%A7%A3%E5%86%B3%20fill%3A%23e8f5e9%2Cstroke%3A%23388e3c%2Cstroke-width%3A2px%0A%20%20%20%20style%20D%20fill%3A%23fff4e1%2Cstroke%3A%23f57c00%2Cstroke-width%3A2px%0A%20%20%20%20style%20A%20fill%3A%23ffcdd2%0A%20%20%20%20style%20B%20fill%3A%23ffcdd2%0A%20%20%20%20style%20C%20fill%3A%23ffcdd2%0A"})]),fallback:a(()=>[...s[5]||(s[5]=[n(" Loading... ",-1)])]),_:1})),s[13]||(s[13]=e(`<p><strong>问题示例：</strong></p><ul><li>moduleA 依赖 moduleB</li><li>moduleB 依赖 moduleC</li><li>moduleC 依赖 moduleA（形成循环依赖）</li></ul><p><strong>解决方案：</strong></p><p><strong>方案 1：提取共享代码到 shared/</strong></p><ul><li>将共同依赖的类型或工具提取到 <code>shared/</code> 目录</li><li>各模块从 <code>shared/</code> 导入，而不是相互导入</li></ul><p><strong>方案 2：使用依赖注入</strong></p><ul><li>通过参数传递依赖，而不是直接导入</li><li>降低模块间的直接耦合</li></ul><p><strong>方案 3：重新设计模块边界</strong></p><ul><li>合并相关模块</li><li>拆分大模块</li><li>调整依赖方向</li></ul><h4 id="模块间通信" tabindex="-1">模块间通信 <a class="header-anchor" href="#模块间通信" aria-label="Permalink to &quot;模块间通信&quot;">​</a></h4><p><strong>推荐方式：</strong></p><ol><li><strong>通过 shared/ 的服务</strong>：跨模块服务放在 <code>shared/</code> 目录</li><li><strong>通过事件总线</strong>：使用消息队列或事件系统</li><li><strong>通过数据库</strong>：通过共享数据表进行通信</li></ol><p><strong>避免方式：</strong></p><ul><li>❌ 模块间直接导入</li><li>❌ 模块间直接调用函数</li><li>❌ 模块间共享状态（应放在 shared/）</li></ul><h2 id="四、分层架构设计" tabindex="-1">四、分层架构设计 <a class="header-anchor" href="#四、分层架构设计" aria-label="Permalink to &quot;四、分层架构设计&quot;">​</a></h2><h3 id="_4-1-api-路由层-routers" tabindex="-1">4.1 API 路由层（Routers） <a class="header-anchor" href="#_4-1-api-路由层-routers" aria-label="Permalink to &quot;4.1 API 路由层（Routers）&quot;">​</a></h3><p><strong>职责：</strong> 定义 API 端点，处理 HTTP 请求和响应</p><p><strong>设计原则：</strong></p><ul><li>路由只负责接收请求和返回响应</li><li>业务逻辑委托给服务层处理</li><li>使用依赖注入获取服务和数据库会话</li><li>统一使用响应模型格式化输出</li></ul><p><strong>目录结构：</strong></p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>modules/user/</span></span>
<span class="line"><span>└── routers.py            # 用户模块路由</span></span></code></pre></div><p><strong>设计要点：</strong></p><ul><li>使用 <code>APIRouter</code> 组织路由</li><li>通过 <code>Depends()</code> 注入依赖（服务、数据库会话、认证等）</li><li>使用 Pydantic 模式验证请求数据</li><li>返回统一的响应格式</li></ul><h3 id="_4-2-服务层-services" tabindex="-1">4.2 服务层（Services） <a class="header-anchor" href="#_4-2-服务层-services" aria-label="Permalink to &quot;4.2 服务层（Services）&quot;">​</a></h3><p><strong>职责：</strong> 实现业务逻辑，协调数据访问和外部服务</p><p><strong>设计原则：</strong></p><ul><li>服务层包含所有业务逻辑</li><li>不直接操作数据库，通过仓储层访问</li><li>处理业务规则和验证</li><li>管理事务边界</li></ul><p><strong>目录结构：</strong></p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>modules/user/</span></span>
<span class="line"><span>└── services.py           # 用户业务逻辑</span></span></code></pre></div><p><strong>设计要点：</strong></p><ul><li>服务类接收数据库会话作为依赖</li><li>通过仓储层访问数据</li><li>处理业务规则和验证逻辑</li><li>可以调用其他服务或共享服务</li></ul><h3 id="_4-3-仓储层-repositories" tabindex="-1">4.3 仓储层（Repositories） <a class="header-anchor" href="#_4-3-仓储层-repositories" aria-label="Permalink to &quot;4.3 仓储层（Repositories）&quot;">​</a></h3><p><strong>职责：</strong> 封装数据访问逻辑，提供数据操作的抽象接口</p><p><strong>设计原则：</strong></p><ul><li>仓储层只负责数据访问</li><li>不包含业务逻辑</li><li>提供通用的 CRUD 操作</li><li>支持复杂查询</li></ul><p><strong>目录结构：</strong></p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>modules/user/</span></span>
<span class="line"><span>└── repositories.py       # 用户数据访问</span></span></code></pre></div><p><strong>设计要点：</strong></p><ul><li>继承基础仓储类（如果使用）</li><li>封装 SQLAlchemy 查询逻辑</li><li>提供类型安全的查询方法</li><li>支持分页和过滤</li></ul><h3 id="_4-4-模型层-models" tabindex="-1">4.4 模型层（Models） <a class="header-anchor" href="#_4-4-模型层-models" aria-label="Permalink to &quot;4.4 模型层（Models）&quot;">​</a></h3><p><strong>职责：</strong> 定义数据模型和数据库表结构</p><p><strong>设计原则：</strong></p><ul><li>使用 SQLAlchemy ORM 定义模型</li><li>模型只包含数据结构定义</li><li>使用关系映射定义表间关系</li><li>支持模型继承和混入</li></ul><p><strong>目录结构：</strong></p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>modules/user/</span></span>
<span class="line"><span>└── models.py             # 用户数据模型</span></span></code></pre></div><p><strong>设计要点：</strong></p><ul><li>继承 <code>Base</code> 模型类</li><li>定义表名和字段</li><li>使用关系映射（relationship）</li><li>支持时间戳和软删除</li></ul><h2 id="五、核心基础设施设计" tabindex="-1">五、核心基础设施设计 <a class="header-anchor" href="#五、核心基础设施设计" aria-label="Permalink to &quot;五、核心基础设施设计&quot;">​</a></h2><h3 id="_5-1-配置管理-config" tabindex="-1">5.1 配置管理（Config） <a class="header-anchor" href="#_5-1-配置管理-config" aria-label="Permalink to &quot;5.1 配置管理（Config）&quot;">​</a></h3><p><strong>职责：</strong> 管理应用配置和环境变量</p><p><strong>设计原则：</strong></p><ul><li>使用 Pydantic Settings 管理配置</li><li>类型安全的配置类</li><li>支持环境变量和默认值</li><li>配置验证和转换</li></ul><p><strong>设计要点：</strong></p><ul><li>基于 <code>BaseSettings</code> 创建配置类</li><li>使用 <code>Field</code> 定义配置项和描述</li><li>使用验证器验证配置值</li><li>支持不同环境的配置</li></ul><h3 id="_5-2-异常处理机制" tabindex="-1">5.2 异常处理机制 <a class="header-anchor" href="#_5-2-异常处理机制" aria-label="Permalink to &quot;5.2 异常处理机制&quot;">​</a></h3><p><strong>职责：</strong> 统一管理异常定义和处理</p><p><strong>设计原则：</strong></p><ul><li>定义异常层次结构</li><li>全局异常处理器统一处理</li><li>提供详细的错误信息</li><li>支持业务异常和系统异常</li></ul><p><strong>目录结构：</strong></p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>core/exceptions/</span></span>
<span class="line"><span>├── __init__.py</span></span>
<span class="line"><span>├── base.py              # 基础异常类</span></span>
<span class="line"><span>├── handlers.py          # 全局异常处理器</span></span>
<span class="line"><span>└── [module]_error.py    # 模块特定异常</span></span></code></pre></div><p><strong>设计要点：</strong></p><ul><li>基础异常类定义通用异常</li><li>业务异常继承基础异常类</li><li>全局异常处理器注册到 FastAPI 应用</li><li>异常自动转换为统一响应格式</li></ul><h3 id="_5-3-响应模型设计" tabindex="-1">5.3 响应模型设计 <a class="header-anchor" href="#_5-3-响应模型设计" aria-label="Permalink to &quot;5.3 响应模型设计&quot;">​</a></h3><p><strong>职责：</strong> 提供统一的 API 响应格式</p><p><strong>设计原则：</strong></p><ul><li>统一的响应结构</li><li>类型安全的响应模型</li><li>支持成功和错误响应</li><li>支持分页响应</li></ul><p><strong>设计要点：</strong></p><ul><li>使用 Pydantic 定义响应模型</li><li>提供响应工具函数</li><li>支持泛型响应模型</li><li>包含时间戳和状态码</li></ul><h3 id="_5-4-安全认证设计" tabindex="-1">5.4 安全认证设计 <a class="header-anchor" href="#_5-4-安全认证设计" aria-label="Permalink to &quot;5.4 安全认证设计&quot;">​</a></h3><p><strong>职责：</strong> 实现认证和授权功能</p><p><strong>设计原则：</strong></p><ul><li>使用依赖注入实现认证</li><li>支持 JWT 和 OAuth2</li><li>权限控制通过策略模式</li><li>提供认证中间件</li></ul><p><strong>目录结构：</strong></p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>core/security/</span></span>
<span class="line"><span>├── __init__.py</span></span>
<span class="line"><span>├── dependencies.py       # 认证依赖注入</span></span>
<span class="line"><span>├── jwt_handler.py        # JWT 处理</span></span>
<span class="line"><span>└── schemas.py            # 安全相关模式</span></span></code></pre></div><p><strong>设计要点：</strong></p><ul><li><code>dependencies.py</code> 提供认证依赖函数</li><li><code>jwt_handler.py</code> 处理 JWT 生成和验证</li><li>使用 <code>Depends()</code> 注入认证依赖</li><li>支持角色和权限检查</li></ul><h2 id="六、数据库设计" tabindex="-1">六、数据库设计 <a class="header-anchor" href="#六、数据库设计" aria-label="Permalink to &quot;六、数据库设计&quot;">​</a></h2><h3 id="_6-1-连接管理" tabindex="-1">6.1 连接管理 <a class="header-anchor" href="#_6-1-连接管理" aria-label="Permalink to &quot;6.1 连接管理&quot;">​</a></h3><p><strong>职责：</strong> 管理数据库连接和会话，是所有持久化能力的“入口层”。</p><p><strong>设计原则：</strong></p><ul><li>使用异步 SQLAlchemy（<code>AsyncEngine</code> + <code>AsyncSession</code>）以契合 FastAPI 的异步调用链；</li><li>通过统一的连接池配置（大小、超时、回收时间等）保证性能与稳定性；</li><li>利用依赖注入控制会话生命周期（请求开始 → 获取 Session → 请求结束自动释放）；</li><li>提供健康检查，监控数据库可用性。</li></ul><p><strong>设计要点：</strong></p><ul><li>在 <code>db/connection.py</code> 创建全局异步引擎和 <code>async_sessionmaker</code>；</li><li>提供 <code>get_async_db()</code> 作为 FastAPI 依赖，确保同一请求共享一个 <code>AsyncSession</code>；</li><li>以“Session = 工作单元（Unit Of Work）”的观念设计：事务要么在 Service 层一次性提交，要么整体回滚；</li><li>预留多数据源扩展位（主库、报表库等分别定义 <code>engine_xxx</code>、<code>get_xxx_db()</code>）；</li><li>在健康检查接口中执行轻量查询（如 <code>SELECT 1</code>）验证连接。</li></ul><p><strong>示例代码：数据库会话依赖模板</strong></p><div class="language-python vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># db/connection.py</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">engine </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> create_async_engine(settings.database_url, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">pool_size</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">10</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">max_overflow</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">20</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">pool_recycle</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3600</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">async_session </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> async_sessionmaker(engine, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">class_</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">AsyncSession, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">expire_on_commit</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">False</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">async</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> get_async_db</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() -&gt; AsyncGenerator[AsyncSession, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">None</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]:</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    async</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> with</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> async_session() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">as</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> session:</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        try</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            yield</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> session</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        finally</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> session.close()</span></span></code></pre></div><h3 id="_6-2-模型设计" tabindex="-1">6.2 模型设计 <a class="header-anchor" href="#_6-2-模型设计" aria-label="Permalink to &quot;6.2 模型设计&quot;">​</a></h3><p><strong>职责：</strong> 定义数据模型和表结构，是数据库中的“真相来源（Single Source of Truth）”。</p><p><strong>设计原则：</strong></p><ul><li>ORM 模型负责持久化结构；Pydantic 模型负责 API 契约，二者分工明确；</li><li>所有业务模型统一继承 <code>Base</code>，复用主键、时间戳、软删除等通用字段/Mixin；</li><li>使用关系映射（<code>relationship</code>、<code>ForeignKey</code>）描述实体关联，减少手写 JOIN；</li><li>通过模型约束（唯一索引、检查约束等）把关键业务规则下沉到数据库层。</li></ul><p><strong>设计要点：</strong></p><ul><li>在 <code>db/base.py</code> 定义统一 <code>Base</code>，集中导出所有模型供迁移工具使用；</li><li>在各模块 <code>models.py</code> 中继承 <code>Base</code>，声明字段类型、索引、关系；</li><li>对需要审计、软删除的实体使用 Mixin 统一注入字段；</li><li>通过 <code>__all__</code> 或包入口聚合模型，方便 <code>alembic</code> 自动发现。</li></ul><p><strong>示例代码：模型模板</strong></p><div class="language-python vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># db/base.py</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Base </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> declarative_base()</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> TimestampMixin</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    created_at </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Column(DateTime, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">default</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">func.now())</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    updated_at </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Column(DateTime, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">default</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">func.now(), </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">onupdate</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">func.now())</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># modules/user/models.py</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> User</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Base</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">TimestampMixin</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">):</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    __tablename__ </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;users&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    id</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Column(UUID(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">as_uuid</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">True</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">), </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">primary_key</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">True</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">default</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">uuid4)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    email </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Column(String, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">unique</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">True</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">index</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">True</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">nullable</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">False</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    organization_id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Column(UUID(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">as_uuid</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">True</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">), ForeignKey(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;organizations.id&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">))</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    organization </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> relationship(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Organization&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">back_populates</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;users&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><h3 id="_6-3-仓储模式" tabindex="-1">6.3 仓储模式 <a class="header-anchor" href="#_6-3-仓储模式" aria-label="Permalink to &quot;6.3 仓储模式&quot;">​</a></h3><p><strong>职责：</strong> 抽象数据访问逻辑，把“如何查/写”的细节从业务层剥离出来。</p><p><strong>设计原则：</strong></p><ul><li>提供基础仓储类，封装通用 CRUD 与分页、排序、过滤等能力；</li><li>模块仓储继承基础仓储，补充领域特有查询；</li><li>Service 层只调用仓储方法而不直接持有 Session，保持职责单一；</li><li>使用类型提示，保证查询结果类型清晰，便于重构。</li></ul><p><strong>设计要点：</strong></p><ul><li>在 <code>db/repositories/base.py</code> 编写 <code>BaseRepository</code>，提供 <code>get() / list() / create()</code> 等方法；</li><li>在模块 <code>repositories.py</code> 中继承基础仓储，并实现业务特有的查询语义；</li><li>在 Service 层通过依赖注入获取 Repository，保持易测性；</li><li>重要查询编写单元测试，确保重构不会破坏 SQL 语义。</li></ul><p><strong>示例代码：仓储 + Service 模板</strong></p><div class="language-python vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># db/repositories/base.py</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> BaseRepository</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(Generic[ModelType]):</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    def</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> __init__</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(self, session: AsyncSession):</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        self</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.session </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> session</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    async</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> get</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(self, pk: Any) -&gt; ModelType </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> None</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> self</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.session.get(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">self</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.model, pk)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># modules/user/repositories.py</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> UserRepository</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(BaseRepository[User]):</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    model </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> User</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    async</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> get_by_email</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(self, email: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">str</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) -&gt; User </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> None</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        stmt </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> select(User).where(User.email </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> email)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        result </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> self</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.session.execute(stmt)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> result.scalars().first()</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># modules/user/services.py</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> UserService</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    def</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> __init__</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(self, repo: UserRepository):</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        self</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.repo </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> repo</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    async</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> create_user</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(self, data: UserCreate) -&gt; User:</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        if</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> self</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.repo.get_by_email(data.email):</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            raise</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> UserAlreadyExistsError()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        user </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> User(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">**</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">data.model_dump())</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        self</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.repo.session.add(user)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        await</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> self</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.repo.session.commit()</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        await</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> self</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.repo.session.refresh(user)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> user</span></span></code></pre></div><h3 id="_6-4-多数据源设计-multiple-data-sources" tabindex="-1">6.4 多数据源设计（Multiple Data Sources） <a class="header-anchor" href="#_6-4-多数据源设计-multiple-data-sources" aria-label="Permalink to &quot;6.4 多数据源设计（Multiple Data Sources）&quot;">​</a></h3><p>实际项目往往不仅只有一个数据库，可能需要同时接入多套关系型数据库、对象存储、缓存或搜索引擎。结构上要提前预留扩展能力。</p><h4 id="_6-4-1-多个关系型数据库" tabindex="-1">6.4.1 多个关系型数据库 <a class="header-anchor" href="#_6-4-1-多个关系型数据库" aria-label="Permalink to &quot;6.4.1 多个关系型数据库&quot;">​</a></h4><p><strong>典型场景：</strong></p><ul><li>主业务库 + 报表库；</li><li>多租户隔离（不同租户使用不同数据库或 schema）；</li><li>事务库与历史归档库分离。</li></ul><p><strong>设计思路：</strong></p><ul><li>为每个数据库创建独立的 <code>AsyncEngine</code>、<code>async_sessionmaker</code> 和依赖函数：<div class="language-python vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">engine_app </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> create_async_engine(settings.database_url)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">engine_analytics </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> create_async_engine(settings.analytics_url)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">async_session_app </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> async_sessionmaker(engine_app, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">class_</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">AsyncSession, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">expire_on_commit</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">False</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">async_session_analytics </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> async_sessionmaker(engine_analytics, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">class_</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">AsyncSession, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">expire_on_commit</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">False</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">async</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> get_app_db</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">():</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    async</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> with</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> async_session_app() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">as</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> session:</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        yield</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> session</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">async</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> get_analytics_db</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">():</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    async</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> with</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> async_session_analytics() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">as</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> session:</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        yield</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> session</span></span></code></pre></div></li><li>可按数据源拆分 Base 和模型：<code>BaseApp</code>、<code>BaseAnalytics</code>，避免模型混淆；</li><li>Repository 明确标注所依赖的数据源，Service 组合不同 Repository 完成业务；</li><li>跨库事务采取“单库强一致 + 跨库最终一致”策略（例如借助事件队列同步报表库）。</li></ul><h4 id="_6-4-2-不同类型数据源-对象存储、缓存、搜索等" tabindex="-1">6.4.2 不同类型数据源（对象存储、缓存、搜索等） <a class="header-anchor" href="#_6-4-2-不同类型数据源-对象存储、缓存、搜索等" aria-label="Permalink to &quot;6.4.2 不同类型数据源（对象存储、缓存、搜索等）&quot;">​</a></h4><p><strong>典型数据源：</strong></p><ul><li>对象存储（MinIO/S3）用于文件与大对象；</li><li>缓存（Redis）用于热点数据、会话、分布式锁；</li><li>搜索/日志/分析引擎（Elasticsearch、ClickHouse 等）。</li></ul><p><strong>结构落点：</strong></p><ul><li>将这些视为“仓储型服务”，统一放在 <code>shared/</code> 层（如 <code>shared/storage/minio_service.py</code>、<code>shared/cache/redis_service.py</code>）；</li><li>Service 通过依赖注入使用这些服务，避免在业务层到处 new 客户端；</li><li>定义抽象接口（如 <code>StorageService</code>、<code>CacheService</code>），便于未来替换实现；</li><li>关系型数据库仍是“真相来源”，缓存/对象存储等作为扩展能力，并通过 Service 层协调写入顺序与一致性策略。</li></ul><h2 id="七、命名规范与约定" tabindex="-1">七、命名规范与约定 <a class="header-anchor" href="#七、命名规范与约定" aria-label="Permalink to &quot;七、命名规范与约定&quot;">​</a></h2><h3 id="_7-1-文件命名规范" tabindex="-1">7.1 文件命名规范 <a class="header-anchor" href="#_7-1-文件命名规范" aria-label="Permalink to &quot;7.1 文件命名规范&quot;">​</a></h3><h4 id="python-文件" tabindex="-1">Python 文件 <a class="header-anchor" href="#python-文件" aria-label="Permalink to &quot;Python 文件&quot;">​</a></h4><ul><li><strong>路由文件：</strong> <code>routers.py</code><ul><li>示例：<code>modules/user/routers.py</code></li></ul></li><li><strong>服务文件：</strong> <code>services.py</code><ul><li>示例：<code>modules/user/services.py</code></li></ul></li><li><strong>仓储文件：</strong> <code>repositories.py</code><ul><li>示例：<code>modules/user/repositories.py</code></li></ul></li><li><strong>模型文件：</strong> <code>models.py</code><ul><li>示例：<code>modules/user/models.py</code></li></ul></li><li><strong>模式文件：</strong> <code>schemas.py</code><ul><li>示例：<code>modules/user/schemas.py</code></li></ul></li></ul><h4 id="配置文件" tabindex="-1">配置文件 <a class="header-anchor" href="#配置文件" aria-label="Permalink to &quot;配置文件&quot;">​</a></h4><ul><li><strong>规范：</strong> snake_case</li><li><strong>示例：</strong> <code>config.py</code>、<code>database.py</code></li></ul><h3 id="_7-2-目录命名规范" tabindex="-1">7.2 目录命名规范 <a class="header-anchor" href="#_7-2-目录命名规范" aria-label="Permalink to &quot;7.2 目录命名规范&quot;">​</a></h3><h4 id="推荐方式" tabindex="-1">推荐方式 <a class="header-anchor" href="#推荐方式" aria-label="Permalink to &quot;推荐方式&quot;">​</a></h4><ul><li><strong>小写字母 + 下划线：</strong> <code>user_management/</code>、<code>project_list/</code></li><li><strong>纯小写字母：</strong> <code>core/</code>、<code>db/</code>、<code>shared/</code></li></ul><h4 id="不推荐" tabindex="-1">不推荐 <a class="header-anchor" href="#不推荐" aria-label="Permalink to &quot;不推荐&quot;">​</a></h4><ul><li>驼峰命名：<code>userManagement/</code>（不符合 Python 规范）</li><li>大写字母：<code>UserManagement/</code>（跨平台兼容性问题）</li></ul><h3 id="_7-3-类和函数命名规范" tabindex="-1">7.3 类和函数命名规范 <a class="header-anchor" href="#_7-3-类和函数命名规范" aria-label="Permalink to &quot;7.3 类和函数命名规范&quot;">​</a></h3><h4 id="类命名" tabindex="-1">类命名 <a class="header-anchor" href="#类命名" aria-label="Permalink to &quot;类命名&quot;">​</a></h4><ul><li><strong>规范：</strong> PascalCase</li><li><strong>示例：</strong> <code>UserService</code>、<code>UserRepository</code>、<code>UserModel</code></li></ul><h4 id="函数命名" tabindex="-1">函数命名 <a class="header-anchor" href="#函数命名" aria-label="Permalink to &quot;函数命名&quot;">​</a></h4><ul><li><strong>规范：</strong> snake_case</li><li><strong>示例：</strong> <code>get_user_by_id</code>、<code>create_user</code>、<code>update_user</code></li></ul><h3 id="_7-4-导入导出规范" tabindex="-1">7.4 导入导出规范 <a class="header-anchor" href="#_7-4-导入导出规范" aria-label="Permalink to &quot;7.4 导入导出规范&quot;">​</a></h3><h4 id="统一使用-init-py" tabindex="-1">统一使用 <strong>init</strong>.py <a class="header-anchor" href="#统一使用-init-py" aria-label="Permalink to &quot;统一使用 __init__.py&quot;">​</a></h4><ul><li>每个目录都应该有一个 <code>__init__.py</code> 作为模块入口</li><li>统一导出目录下的重要内容，简化导入路径</li><li>例如：<code>modules/user/__init__.py</code> 导出该模块的主要类</li></ul><h4 id="导入顺序" tabindex="-1">导入顺序 <a class="header-anchor" href="#导入顺序" aria-label="Permalink to &quot;导入顺序&quot;">​</a></h4><ol><li>标准库导入</li><li>第三方库导入</li><li>本地应用导入</li></ol><h2 id="八、工程化配置" tabindex="-1">八、工程化配置 <a class="header-anchor" href="#八、工程化配置" aria-label="Permalink to &quot;八、工程化配置&quot;">​</a></h2><h3 id="_8-1-依赖管理" tabindex="-1">8.1 依赖管理 <a class="header-anchor" href="#_8-1-依赖管理" aria-label="Permalink to &quot;8.1 依赖管理&quot;">​</a></h3><h4 id="pyproject-toml-配置" tabindex="-1">pyproject.toml 配置 <a class="header-anchor" href="#pyproject-toml-配置" aria-label="Permalink to &quot;pyproject.toml 配置&quot;">​</a></h4><ul><li>使用 <code>pyproject.toml</code> 管理项目配置和依赖</li><li>定义项目元数据和依赖版本</li><li>支持开发依赖和可选依赖</li></ul><h4 id="虚拟环境管理" tabindex="-1">虚拟环境管理 <a class="header-anchor" href="#虚拟环境管理" aria-label="Permalink to &quot;虚拟环境管理&quot;">​</a></h4><ul><li>使用 <code>uv</code> 或 <code>poetry</code> 管理虚拟环境</li><li>锁定依赖版本，确保环境一致性</li><li>支持多环境配置</li></ul><blockquote><p>💡 <strong>推荐使用 uv</strong>：uv 是由 Astral（Ruff 的开发者）开发的极快 Python 包管理器，使用 Rust 编写，比 pip 快 10-100 倍。它集成了包管理、虚拟环境、Python 版本管理、脚本运行等功能，可以替代 pip、pip-tools、pipx、poetry、virtualenv 等多个工具。详细使用指南请参考：<a href="https://blog.mapin.net/posts/uv%20Python%20%E5%8C%85%E7%AE%A1%E7%90%86%E5%99%A8%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97" target="_blank" rel="noreferrer">uv Python 包管理器使用指南</a>。</p></blockquote><h3 id="_8-2-环境配置" tabindex="-1">8.2 环境配置 <a class="header-anchor" href="#_8-2-环境配置" aria-label="Permalink to &quot;8.2 环境配置&quot;">​</a></h3><h4 id="环境变量管理" tabindex="-1">环境变量管理 <a class="header-anchor" href="#环境变量管理" aria-label="Permalink to &quot;环境变量管理&quot;">​</a></h4><ul><li>使用 <code>.env</code> 文件管理环境变量</li><li>提供 <code>.env.example</code> 作为模板</li><li>使用 Pydantic Settings 加载和验证</li></ul><h4 id="多环境支持" tabindex="-1">多环境支持 <a class="header-anchor" href="#多环境支持" aria-label="Permalink to &quot;多环境支持&quot;">​</a></h4><ul><li>支持开发、测试、生产环境</li><li>不同环境使用不同配置</li><li>敏感信息通过环境变量注入</li></ul><h3 id="_8-3-代码质量工具" tabindex="-1">8.3 代码质量工具 <a class="header-anchor" href="#_8-3-代码质量工具" aria-label="Permalink to &quot;8.3 代码质量工具&quot;">​</a></h3><h4 id="black-代码格式化" tabindex="-1">Black（代码格式化） <a class="header-anchor" href="#black-代码格式化" aria-label="Permalink to &quot;Black（代码格式化）&quot;">​</a></h4><ul><li>统一代码格式化规则</li><li>自动格式化代码</li><li>集成到开发流程</li></ul><h4 id="isort-导入排序" tabindex="-1">isort（导入排序） <a class="header-anchor" href="#isort-导入排序" aria-label="Permalink to &quot;isort（导入排序）&quot;">​</a></h4><ul><li>自动排序导入语句</li><li>按标准库、第三方、本地应用分组</li><li>与 Black 配合使用</li></ul><h4 id="mypy-类型检查" tabindex="-1">mypy（类型检查） <a class="header-anchor" href="#mypy-类型检查" aria-label="Permalink to &quot;mypy（类型检查）&quot;">​</a></h4><ul><li>静态类型检查</li><li>提升代码质量</li><li>发现潜在错误</li></ul><h4 id="pylint-flake8-代码检查" tabindex="-1">pylint/flake8（代码检查） <a class="header-anchor" href="#pylint-flake8-代码检查" aria-label="Permalink to &quot;pylint/flake8（代码检查）&quot;">​</a></h4><ul><li>代码风格检查</li><li>发现代码问题</li><li>提升代码质量</li></ul><h3 id="_8-4-测试配置" tabindex="-1">8.4 测试配置 <a class="header-anchor" href="#_8-4-测试配置" aria-label="Permalink to &quot;8.4 测试配置&quot;">​</a></h3><h4 id="pytest-配置" tabindex="-1">pytest 配置 <a class="header-anchor" href="#pytest-配置" aria-label="Permalink to &quot;pytest 配置&quot;">​</a></h4><ul><li>使用 pytest 作为测试框架</li><li>配置测试目录和文件命名</li><li>支持异步测试</li></ul><h4 id="测试目录结构" tabindex="-1">测试目录结构 <a class="header-anchor" href="#测试目录结构" aria-label="Permalink to &quot;测试目录结构&quot;">​</a></h4><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>tests/</span></span>
<span class="line"><span>├── __init__.py</span></span>
<span class="line"><span>├── conftest.py          # pytest 配置和 fixtures</span></span>
<span class="line"><span>└── modules/             # 按模块组织测试</span></span>
<span class="line"><span>    ├── user/</span></span>
<span class="line"><span>    │   ├── test_models.py</span></span>
<span class="line"><span>    │   ├── test_services.py</span></span>
<span class="line"><span>    │   └── test_routers.py</span></span>
<span class="line"><span>    └── project/</span></span></code></pre></div><h2 id="九、最佳实践与建议" tabindex="-1">九、最佳实践与建议 <a class="header-anchor" href="#九、最佳实践与建议" aria-label="Permalink to &quot;九、最佳实践与建议&quot;">​</a></h2><h3 id="_9-1-目录深度控制" tabindex="-1">9.1 目录深度控制 <a class="header-anchor" href="#_9-1-目录深度控制" aria-label="Permalink to &quot;9.1 目录深度控制&quot;">​</a></h3><h4 id="建议不超过-4-层嵌套" tabindex="-1">建议不超过 4 层嵌套 <a class="header-anchor" href="#建议不超过-4-层嵌套" aria-label="Permalink to &quot;建议不超过 4 层嵌套&quot;">​</a></h4><p><strong>好的结构：</strong></p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>app/</span></span>
<span class="line"><span>├── modules/</span></span>
<span class="line"><span>│   └── user/</span></span>
<span class="line"><span>│       └── services.py  # 3 层</span></span></code></pre></div><p><strong>避免过深：</strong></p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>app/</span></span>
<span class="line"><span>├── features/</span></span>
<span class="line"><span>│   └── user-management/</span></span>
<span class="line"><span>│       └── business/</span></span>
<span class="line"><span>│           └── logic/</span></span>
<span class="line"><span>│               └── services.py  # 5 层，过深！</span></span></code></pre></div><h4 id="保持结构扁平化" tabindex="-1">保持结构扁平化 <a class="header-anchor" href="#保持结构扁平化" aria-label="Permalink to &quot;保持结构扁平化&quot;">​</a></h4><ul><li>优先考虑扁平化结构</li><li>只有在确实需要时才增加嵌套层级</li><li>使用清晰的命名减少对深层嵌套的需求</li></ul><h3 id="_9-2-代码组织原则" tabindex="-1">9.2 代码组织原则 <a class="header-anchor" href="#_9-2-代码组织原则" aria-label="Permalink to &quot;9.2 代码组织原则&quot;">​</a></h3><h4 id="就近原则-相关代码放在一起" tabindex="-1">就近原则（相关代码放在一起） <a class="header-anchor" href="#就近原则-相关代码放在一起" aria-label="Permalink to &quot;就近原则（相关代码放在一起）&quot;">​</a></h4><p>将相关的代码放在同一个目录或附近，便于查找和维护。</p><p><strong>示例：</strong></p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>modules/user/</span></span>
<span class="line"><span>├── models.py</span></span>
<span class="line"><span>├── schemas.py</span></span>
<span class="line"><span>├── repositories.py</span></span>
<span class="line"><span>├── services.py</span></span>
<span class="line"><span>└── routers.py</span></span></code></pre></div><p>这些文件都相关，放在一起更合理。</p><h4 id="单一数据源-避免重复定义" tabindex="-1">单一数据源（避免重复定义） <a class="header-anchor" href="#单一数据源-避免重复定义" aria-label="Permalink to &quot;单一数据源（避免重复定义）&quot;">​</a></h4><p>同一个数据或类型只在一个地方定义，其他地方通过导入使用。</p><p><strong>避免：</strong></p><ul><li>在多个文件中重复定义相同的模型或模式</li><li>导致维护困难，修改时需要同步多个地方</li></ul><p><strong>推荐：</strong></p><ul><li>在 <code>models.py</code> 或 <code>schemas.py</code> 中统一定义</li><li>其他地方通过导入使用，确保单一数据源</li></ul><h4 id="关注点分离" tabindex="-1">关注点分离 <a class="header-anchor" href="#关注点分离" aria-label="Permalink to &quot;关注点分离&quot;">​</a></h4><p>不同职责的代码应该分离到不同的文件或目录。</p><p><strong>示例：</strong></p><ul><li>API 路由逻辑 → <code>routers.py</code></li><li>业务逻辑 → <code>services.py</code></li><li>数据访问逻辑 → <code>repositories.py</code></li><li>数据模型 → <code>models.py</code></li></ul><h3 id="_9-3-可维护性提升" tabindex="-1">9.3 可维护性提升 <a class="header-anchor" href="#_9-3-可维护性提升" aria-label="Permalink to &quot;9.3 可维护性提升&quot;">​</a></h3><h4 id="清晰的目录结构" tabindex="-1">清晰的目录结构 <a class="header-anchor" href="#清晰的目录结构" aria-label="Permalink to &quot;清晰的目录结构&quot;">​</a></h4><ul><li>目录名称应该清晰表达其用途</li><li>遵循一致的命名规范</li><li>使用 <code>README.md</code> 说明复杂目录的用途</li></ul><h4 id="一致的命名规范" tabindex="-1">一致的命名规范 <a class="header-anchor" href="#一致的命名规范" aria-label="Permalink to &quot;一致的命名规范&quot;">​</a></h4><p>在整个项目中保持命名规范的一致性：</p><ul><li>文件命名规范统一</li><li>类命名规范统一</li><li>函数命名规范统一</li></ul><h4 id="完善的类型定义" tabindex="-1">完善的类型定义 <a class="header-anchor" href="#完善的类型定义" aria-label="Permalink to &quot;完善的类型定义&quot;">​</a></h4><ul><li>为所有函数参数和返回值添加类型提示</li><li>使用 Pydantic 模型定义 API 请求和响应</li><li>避免使用 <code>Any</code> 类型</li></ul><h4 id="适当的注释和文档" tabindex="-1">适当的注释和文档 <a class="header-anchor" href="#适当的注释和文档" aria-label="Permalink to &quot;适当的注释和文档&quot;">​</a></h4><ul><li>为复杂逻辑添加注释，说明设计思路和实现细节</li><li>为公共 API 添加文档字符串（docstring）</li><li>在关键目录添加 <code>README.md</code> 说明，解释目录用途和设计原则</li></ul><h2 id="十、常见问题与解决方案" tabindex="-1">十、常见问题与解决方案 <a class="header-anchor" href="#十、常见问题与解决方案" aria-label="Permalink to &quot;十、常见问题与解决方案&quot;">​</a></h2><h3 id="_10-1-循环依赖问题" tabindex="-1">10.1 循环依赖问题 <a class="header-anchor" href="#_10-1-循环依赖问题" aria-label="Permalink to &quot;10.1 循环依赖问题&quot;">​</a></h3><h4 id="问题描述" tabindex="-1">问题描述 <a class="header-anchor" href="#问题描述" aria-label="Permalink to &quot;问题描述&quot;">​</a></h4><p>模块 A 依赖模块 B，模块 B 又依赖模块 A，形成循环依赖。</p><h4 id="解决方案" tabindex="-1">解决方案 <a class="header-anchor" href="#解决方案" aria-label="Permalink to &quot;解决方案&quot;">​</a></h4><p><strong>方案 1：提取共享代码到 shared/</strong></p><ul><li>将共同依赖的类型或工具提取到 <code>shared/</code> 目录</li><li>各模块从 <code>shared/</code> 导入，而不是相互导入</li></ul><p><strong>方案 2：使用依赖注入</strong></p><ul><li>通过参数传递依赖，而不是直接导入</li><li>降低模块间的直接耦合</li></ul><p><strong>方案 3：重新设计模块边界</strong></p><ul><li>合并相关模块</li><li>拆分大模块</li><li>调整依赖方向</li></ul><h3 id="_10-2-类型定义重复" tabindex="-1">10.2 类型定义重复 <a class="header-anchor" href="#_10-2-类型定义重复" aria-label="Permalink to &quot;10.2 类型定义重复&quot;">​</a></h3><h4 id="问题描述-1" tabindex="-1">问题描述 <a class="header-anchor" href="#问题描述-1" aria-label="Permalink to &quot;问题描述&quot;">​</a></h4><p>同一个类型在多个地方定义，导致维护困难。</p><h4 id="解决方案-1" tabindex="-1">解决方案 <a class="header-anchor" href="#解决方案-1" aria-label="Permalink to &quot;解决方案&quot;">​</a></h4><p><strong>统一类型定义位置：</strong></p><ul><li>在 <code>schemas.py</code> 中统一定义模块的所有 Pydantic 模式</li><li>其他地方统一从该文件导入，避免重复定义</li></ul><p><strong>使用类型工具：</strong></p><ul><li>使用 Pydantic 的模型继承和组合</li><li>通过模型组合和推导减少类型定义</li></ul><h3 id="_10-3-模块边界模糊" tabindex="-1">10.3 模块边界模糊 <a class="header-anchor" href="#_10-3-模块边界模糊" aria-label="Permalink to &quot;10.3 模块边界模糊&quot;">​</a></h3><h4 id="问题描述-2" tabindex="-1">问题描述 <a class="header-anchor" href="#问题描述-2" aria-label="Permalink to &quot;问题描述&quot;">​</a></h4><p>不清楚某个功能应该放在哪个模块，导致代码组织混乱。</p><h4 id="解决方案-2" tabindex="-1">解决方案 <a class="header-anchor" href="#解决方案-2" aria-label="Permalink to &quot;解决方案&quot;">​</a></h4><p><strong>明确模块职责：</strong></p><ul><li>为每个模块定义清晰的职责范围</li><li>使用文档说明模块的边界</li><li>定期审查和重构模块结构</li></ul><p><strong>建立模块规范：</strong></p><ul><li>为每个模块创建 <code>README.md</code> 文档</li><li>明确模块的职责范围和不包含的内容</li><li>说明模块的边界和与其他模块的关系</li></ul><h3 id="_10-4-代码组织混乱" tabindex="-1">10.4 代码组织混乱 <a class="header-anchor" href="#_10-4-代码组织混乱" aria-label="Permalink to &quot;10.4 代码组织混乱&quot;">​</a></h3><h4 id="问题描述-3" tabindex="-1">问题描述 <a class="header-anchor" href="#问题描述-3" aria-label="Permalink to &quot;问题描述&quot;">​</a></h4><p>随着项目发展，代码组织变得混乱，难以维护。</p><h4 id="解决方案-3" tabindex="-1">解决方案 <a class="header-anchor" href="#解决方案-3" aria-label="Permalink to &quot;解决方案&quot;">​</a></h4><p><strong>定期重构：</strong></p><ul><li>定期审查目录结构</li><li>重构不符合规范的代码</li><li>提取重复代码到公共层</li></ul><p><strong>建立代码审查机制：</strong></p><ul><li>在 PR 中检查代码组织</li><li>使用工具检查目录结构</li><li>制定代码组织规范文档</li></ul><p><strong>使用工具辅助：</strong></p><ul><li>使用 pylint/flake8 检查导入路径</li><li>使用工具检查循环依赖</li><li>使用代码分析工具识别问题</li></ul><h2 id="十一、总结" tabindex="-1">十一、总结 <a class="header-anchor" href="#十一、总结" aria-label="Permalink to &quot;十一、总结&quot;">​</a></h2><h3 id="工程化结构设计的核心目标" tabindex="-1">工程化结构设计的核心目标 <a class="header-anchor" href="#工程化结构设计的核心目标" aria-label="Permalink to &quot;工程化结构设计的核心目标&quot;">​</a></h3><ol><li><strong>可维护性</strong>：清晰的目录结构使代码易于理解和修改</li><li><strong>可扩展性</strong>：模块化设计便于添加新功能</li><li><strong>可测试性</strong>：良好的结构使单元测试和集成测试更容易</li><li><strong>团队协作</strong>：统一的规范减少沟通成本，提高开发效率</li><li><strong>类型安全</strong>：完善的类型定义提升代码质量和开发体验</li></ol><h3 id="关键设计原则回顾" tabindex="-1">关键设计原则回顾 <a class="header-anchor" href="#关键设计原则回顾" aria-label="Permalink to &quot;关键设计原则回顾&quot;">​</a></h3><ol><li><strong>关注点分离</strong>：不同职责的代码分离到不同目录</li><li><strong>单一职责</strong>：每个文件、每个目录都有明确的单一职责</li><li><strong>模块化与解耦</strong>：通过模块化设计降低代码耦合度</li><li><strong>约定优于配置</strong>：建立清晰的命名和结构约定</li><li><strong>一致性原则</strong>：在整个项目中保持结构、命名的一致性</li></ol><h3 id="实践建议" tabindex="-1">实践建议 <a class="header-anchor" href="#实践建议" aria-label="Permalink to &quot;实践建议&quot;">​</a></h3><ol><li><strong>渐进式演进</strong>：从扁平化结构开始，根据项目发展逐步演进到混合模式</li><li><strong>明确划分标准</strong>：建立清晰的&quot;core/shared/modules&quot;划分标准，减少决策成本</li><li><strong>团队共识</strong>：确保团队成员理解并遵循结构规范，特别是代码放置的决策树</li><li><strong>定期审查</strong>：定期审查目录结构，及时重构不符合规范的部分</li><li><strong>文档维护</strong>：保持文档与代码同步，及时更新结构说明和划分标准</li></ol><h3 id="设计模式选择总结" tabindex="-1">设计模式选择总结 <a class="header-anchor" href="#设计模式选择总结" aria-label="Permalink to &quot;设计模式选择总结&quot;">​</a></h3><table tabindex="0"><thead><tr><th>维度</th><th>扁平化结构</th><th>混合模式</th></tr></thead><tbody><tr><td><strong>适用规模</strong></td><td>小型项目（&lt; 10 API端点）</td><td>中大型项目（&gt; 10 API端点）</td></tr><tr><td><strong>团队规模</strong></td><td>1-2 人</td><td>3+ 人</td></tr><tr><td><strong>认知负担</strong></td><td>低</td><td>中等</td></tr><tr><td><strong>路径长度</strong></td><td>短</td><td>较长</td></tr><tr><td><strong>模块边界</strong></td><td>模糊</td><td>清晰</td></tr><tr><td><strong>并行协作</strong></td><td>容易冲突</td><td>支持良好</td></tr><tr><td><strong>模块拆分</strong></td><td>困难</td><td>容易</td></tr><tr><td><strong>可扩展性</strong></td><td>中等</td><td>高</td></tr></tbody></table><p><strong>核心原则：</strong></p><ul><li><strong>不要过度设计</strong>：项目初期保持简单，使用扁平化结构</li><li><strong>及时演进</strong>：当结构成为瓶颈时（文件难以定位、协作冲突增多），及时调整</li><li><strong>保持一致性</strong>：一旦选择某种结构，全项目保持一致</li><li><strong>文档先行</strong>：为结构划分建立清晰的文档和规范</li></ul><h3 id="结语" tabindex="-1">结语 <a class="header-anchor" href="#结语" aria-label="Permalink to &quot;结语&quot;">​</a></h3><p>良好的工程化结构是项目成功的基础。虽然初期可能需要一些额外的时间来建立和维护结构，但这些投入会在项目的长期维护中带来巨大的回报。</p><p><strong>关键洞察：</strong></p><ol><li><strong>没有完美的结构，只有适合项目的结构</strong>：根据项目规模、团队规模、业务复杂度选择</li><li><strong>结构应该渐进式演进</strong>：从简单开始，随项目发展逐步复杂化</li><li><strong>明确的划分标准比复杂的结构更重要</strong>：清晰的决策树能减少团队决策成本</li></ol><p>根据项目的实际情况，灵活应用本文档中的原则和建议，构建属于你的工程化项目结构。记住，最好的结构是能够支持团队高效协作、代码易于维护和扩展的结构。</p><hr><h2 id="十二、快速启动模板仓库" tabindex="-1">十二、快速启动模板仓库 <a class="header-anchor" href="#十二、快速启动模板仓库" aria-label="Permalink to &quot;十二、快速启动模板仓库&quot;">​</a></h2><p>以下是一些优秀的 FastAPI 工程化模板仓库，可以直接使用或作为参考：</p><h3 id="官方模板" tabindex="-1">官方模板 <a class="header-anchor" href="#官方模板" aria-label="Permalink to &quot;官方模板&quot;">​</a></h3><h4 id="_1-fastapi-官方模板" tabindex="-1">1. FastAPI 官方模板 <a class="header-anchor" href="#_1-fastapi-官方模板" aria-label="Permalink to &quot;1. FastAPI 官方模板&quot;">​</a></h4><ul><li><strong>创建命令</strong>：<code>fastapi new my-app</code></li><li><strong>特点</strong>： <ul><li>FastAPI 官方维护，最权威的模板</li><li>包含基础项目结构</li><li>使用 Pydantic 和 SQLAlchemy</li><li>结构简洁，适合快速开始</li></ul></li><li><strong>适用场景</strong>：学习、小型项目、快速原型</li></ul><h3 id="社区优秀模板" tabindex="-1">社区优秀模板 <a class="header-anchor" href="#社区优秀模板" aria-label="Permalink to &quot;社区优秀模板&quot;">​</a></h3><h4 id="_2-fastapi-full-stack" tabindex="-1">2. FastAPI Full Stack <a class="header-anchor" href="#_2-fastapi-full-stack" aria-label="Permalink to &quot;2. FastAPI Full Stack&quot;">​</a></h4><ul><li><strong>GitHub</strong>：<code>tiangolo/full-stack-fastapi-template</code></li><li><strong>技术栈</strong>：FastAPI + SQLAlchemy + PostgreSQL + Docker</li><li><strong>特点</strong>： <ul><li>FastAPI 作者维护的完整模板</li><li>包含前端（Vue）和后端</li><li>完整的认证和授权系统</li><li>Docker 容器化支持</li></ul></li><li><strong>适用场景</strong>：全栈项目快速启动</li><li><strong>推荐指数</strong>：⭐⭐⭐⭐⭐</li></ul><h4 id="_3-fastapi-project-template" tabindex="-1">3. FastAPI Project Template <a class="header-anchor" href="#_3-fastapi-project-template" aria-label="Permalink to &quot;3. FastAPI Project Template&quot;">​</a></h4><ul><li><strong>GitHub</strong>：<code>tiangolo/fastapi-project-template</code></li><li><strong>技术栈</strong>：FastAPI + SQLAlchemy + PostgreSQL</li><li><strong>特点</strong>： <ul><li>官方推荐的项目模板</li><li>包含完整的项目结构</li><li>支持 Docker 部署</li><li>文档完善</li></ul></li><li><strong>适用场景</strong>：中大型项目</li><li><strong>推荐指数</strong>：⭐⭐⭐⭐⭐</li></ul><h4 id="_4-fastapi-boilerplate" tabindex="-1">4. FastAPI Boilerplate <a class="header-anchor" href="#_4-fastapi-boilerplate" aria-label="Permalink to &quot;4. FastAPI Boilerplate&quot;">​</a></h4><ul><li><strong>GitHub</strong>：搜索 <code>fastapi-boilerplate</code></li><li><strong>技术栈</strong>：FastAPI + SQLAlchemy + PostgreSQL + Redis</li><li><strong>特点</strong>： <ul><li>企业级项目模板</li><li>包含完整的认证系统</li><li>支持 Redis 缓存</li><li>包含测试配置</li></ul></li><li><strong>适用场景</strong>：企业级应用</li></ul><h4 id="_5-fastapi-sqlalchemy-template" tabindex="-1">5. FastAPI SQLAlchemy Template <a class="header-anchor" href="#_5-fastapi-sqlalchemy-template" aria-label="Permalink to &quot;5. FastAPI SQLAlchemy Template&quot;">​</a></h4><ul><li><strong>GitHub</strong>：搜索 <code>fastapi-sqlalchemy-template</code></li><li><strong>技术栈</strong>：FastAPI + SQLAlchemy + PostgreSQL</li><li><strong>特点</strong>： <ul><li>专注于 SQLAlchemy 集成</li><li>包含仓储模式实现</li><li>支持异步数据库操作</li></ul></li><li><strong>适用场景</strong>：数据库密集型应用</li></ul><h3 id="模板选择指南" tabindex="-1">模板选择指南 <a class="header-anchor" href="#模板选择指南" aria-label="Permalink to &quot;模板选择指南&quot;">​</a></h3>`,264)),(i(),p(r,null,{default:a(()=>[t(l,{id:"mermaid-3519",class:"mermaid",graph:"flowchart%20TD%0A%20%20%20%20A%5B%E9%80%89%E6%8B%A9%E6%A8%A1%E6%9D%BF%5D%20--%3E%20B%7B%E9%A1%B9%E7%9B%AE%E7%B1%BB%E5%9E%8B%3F%7D%0A%20%20%20%20B%20--%3E%7C%E5%AD%A6%E4%B9%A0%2F%E5%B0%8F%E5%9E%8B%E9%A1%B9%E7%9B%AE%7C%20C%5BFastAPI%20%E5%AE%98%E6%96%B9%E6%A8%A1%E6%9D%BF%3Cbr%2F%3Efastapi%20new%5D%0A%20%20%20%20B%20--%3E%7C%E5%85%A8%E6%A0%88%E9%A1%B9%E7%9B%AE%7C%20D%5BFastAPI%20Full%20Stack%3Cbr%2F%3Etiangolo%2Ffull-stack-fastapi-template%5D%0A%20%20%20%20B%20--%3E%7C%E4%BC%81%E4%B8%9A%E7%BA%A7%E5%BA%94%E7%94%A8%7C%20E%5BFastAPI%20Project%20Template%3Cbr%2F%3Etiangolo%2Ffastapi-project-template%5D%0A%20%20%20%20B%20--%3E%7C%E9%9C%80%E8%A6%81%E7%BC%93%E5%AD%98%7C%20F%5BFastAPI%20Boilerplate%5D%0A%20%20%20%20B%20--%3E%7C%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AF%86%E9%9B%86%E5%9E%8B%7C%20G%5BFastAPI%20SQLAlchemy%20Template%5D%0A%20%20%20%20%0A%20%20%20%20style%20C%20fill%3A%23e1f5ff%0A%20%20%20%20style%20D%20fill%3A%23e8f5e9%0A%20%20%20%20style%20E%20fill%3A%23e8f5e9%0A%20%20%20%20style%20F%20fill%3A%23fff4e1%0A%20%20%20%20style%20G%20fill%3A%23fff4e1%0A"})]),fallback:a(()=>[...s[6]||(s[6]=[n(" Loading... ",-1)])]),_:1})),s[14]||(s[14]=e('<h3 id="推荐使用方式" tabindex="-1">推荐使用方式 <a class="header-anchor" href="#推荐使用方式" aria-label="Permalink to &quot;推荐使用方式&quot;">​</a></h3><ol><li><p><strong>学习阶段</strong>：</p><ul><li>使用官方模板 <code>fastapi new</code></li><li>从零开始理解结构，参考本文档的设计原则</li></ul></li><li><p><strong>快速开发</strong>：</p><ul><li>使用社区成熟模板（如 <code>fastapi-project-template</code>）</li><li>快速搭建项目，专注于业务开发</li></ul></li><li><p><strong>自定义需求</strong>：</p><ul><li>基于本文档的设计原则</li><li>参考模板仓库的结构</li><li>根据项目需求自行搭建</li></ul></li></ol><h3 id="模板对比表" tabindex="-1">模板对比表 <a class="header-anchor" href="#模板对比表" aria-label="Permalink to &quot;模板对比表&quot;">​</a></h3><table tabindex="0"><thead><tr><th>模板名称</th><th>技术栈</th><th>适用规模</th><th>推荐场景</th><th>维护状态</th></tr></thead><tbody><tr><td><strong>FastAPI 官方模板</strong></td><td>FastAPI</td><td>小型</td><td>学习、原型</td><td>⭐⭐⭐⭐⭐</td></tr><tr><td><strong>FastAPI Full Stack</strong></td><td>FastAPI + Vue</td><td>中大型</td><td>全栈项目</td><td>⭐⭐⭐⭐⭐</td></tr><tr><td><strong>FastAPI Project Template</strong></td><td>FastAPI + SQLAlchemy</td><td>中大型</td><td>企业级应用</td><td>⭐⭐⭐⭐⭐</td></tr><tr><td><strong>FastAPI Boilerplate</strong></td><td>FastAPI + Redis</td><td>中大型</td><td>需要缓存的应用</td><td>⭐⭐⭐⭐</td></tr><tr><td><strong>FastAPI SQLAlchemy Template</strong></td><td>FastAPI + SQLAlchemy</td><td>中大型</td><td>数据库密集型</td><td>⭐⭐⭐⭐</td></tr></tbody></table><h3 id="使用模板的注意事项" tabindex="-1">使用模板的注意事项 <a class="header-anchor" href="#使用模板的注意事项" aria-label="Permalink to &quot;使用模板的注意事项&quot;">​</a></h3><ol><li><strong>理解结构</strong>：不要直接使用，先理解模板的目录结构设计</li><li><strong>按需调整</strong>：根据项目需求调整结构，删除不需要的功能</li><li><strong>保持规范</strong>：遵循本文档的设计原则，确保结构清晰</li><li><strong>渐进演进</strong>：从简单结构开始，随项目发展逐步演进</li><li><strong>关注更新</strong>：定期关注模板的更新，但不要盲目升级</li></ol><hr><h2 id="参考资源" tabindex="-1">参考资源 <a class="header-anchor" href="#参考资源" aria-label="Permalink to &quot;参考资源&quot;">​</a></h2><h3 id="官方文档" tabindex="-1">官方文档 <a class="header-anchor" href="#官方文档" aria-label="Permalink to &quot;官方文档&quot;">​</a></h3><ul><li><a href="https://fastapi.tiangolo.com/" target="_blank" rel="noreferrer">FastAPI 官方文档</a></li><li><a href="https://docs.python.org/" target="_blank" rel="noreferrer">Python 官方文档</a></li><li><a href="https://docs.sqlalchemy.org/" target="_blank" rel="noreferrer">SQLAlchemy 官方文档</a></li><li><a href="https://docs.pydantic.dev/" target="_blank" rel="noreferrer">Pydantic 官方文档</a></li></ul><h3 id="相关工具" tabindex="-1">相关工具 <a class="header-anchor" href="#相关工具" aria-label="Permalink to &quot;相关工具&quot;">​</a></h3><ul><li><a href="https://black.readthedocs.io/" target="_blank" rel="noreferrer">Black 代码格式化</a></li><li><a href="https://pycqa.github.io/isort/" target="_blank" rel="noreferrer">isort 导入排序</a></li><li><a href="https://mypy.readthedocs.io/" target="_blank" rel="noreferrer">mypy 类型检查</a></li><li><a href="https://docs.pytest.org/" target="_blank" rel="noreferrer">pytest 测试框架</a></li></ul>',12))])}const m=h(k,[["render",E]]);export{B as __pageData,m as default};

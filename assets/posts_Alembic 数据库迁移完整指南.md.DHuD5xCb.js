import{_ as t,C as l,c as h,o as i,a0 as a,b as o,w as e,a as r,G as p,a2 as d}from"./chunks/framework.DXI-tbPr.js";const A=JSON.parse('{"title":"Alembic 数据库迁移完整指南","description":"基于实际项目经验，提供 Alembic 数据库迁移的完整实战指南。涵盖从零初始化、异步模式配置、开发工作流、生产环境部署到常见坑点解决方案。","frontmatter":{"title":"Alembic 数据库迁移完整指南","description":"基于实际项目经验，提供 Alembic 数据库迁移的完整实战指南。涵盖从零初始化、异步模式配置、开发工作流、生产环境部署到常见坑点解决方案。","date":"2026-02-03T14:07:00.000Z","tags":["Alembic","SQLAlchemy","Python"]},"headers":[],"relativePath":"posts/Alembic 数据库迁移完整指南.md","filePath":"posts/Alembic 数据库迁移完整指南.md","lastUpdated":1770167720000}'),k={name:"posts/Alembic 数据库迁移完整指南.md"};function c(g,s,E,u,b,y){const n=l("Mermaid");return i(),h("div",null,[s[1]||(s[1]=a(`<h1 id="alembic-数据库迁移完整指南" tabindex="-1">Alembic 数据库迁移完整指南 <a class="header-anchor" href="#alembic-数据库迁移完整指南" aria-label="Permalink to &quot;Alembic 数据库迁移完整指南&quot;">​</a></h1><blockquote><p>本指南基于 FastAPI + SQLAlchemy + Asyncpg 的现代化异步后端架构，详细阐述如何引入和规范使用 Alembic 进行数据库版本管理。</p></blockquote><h2 id="目录" tabindex="-1">目录 <a class="header-anchor" href="#目录" aria-label="Permalink to &quot;目录&quot;">​</a></h2><ul><li><a href="#一核心概念与价值">一、核心概念与价值</a></li><li><a href="#二环境初始化与配置">二、环境初始化与配置</a></li><li><a href="#三开发阶段工作流">三、开发阶段工作流</a></li><li><a href="#四生产环境部署方案">四、生产环境部署方案</a></li><li><a href="#五关键坑点与解决方案">五、关键坑点与解决方案</a></li><li><a href="#六常用命令速查">六、常用命令速查</a></li></ul><hr><h2 id="一、核心概念与价值" tabindex="-1">一、核心概念与价值 <a class="header-anchor" href="#一、核心概念与价值" aria-label="Permalink to &quot;一、核心概念与价值&quot;">​</a></h2><h3 id="_1-1-为什么要用-alembic" tabindex="-1">1.1 为什么要用 Alembic？ <a class="header-anchor" href="#_1-1-为什么要用-alembic" aria-label="Permalink to &quot;1.1 为什么要用 Alembic？&quot;">​</a></h3><p>在项目初期，我们可能会使用 <code>Base.metadata.create_all(engine)</code> 来自动建表。但这在生产环境中存在严重问题：</p><ul><li><strong>无法修改表结构</strong>：一旦表存在，<code>create_all</code> 不会检测字段变更（如增加一列）。</li><li><strong>缺乏版本控制</strong>：数据库的变更没有记录，无法回滚。</li><li><strong>环境不一致</strong>：开发、测试、生产环境的数据库结构难以保持同步。</li></ul><p>Alembic 通过生成迁移脚本（Migration Scripts），将数据库的每一次变更代码化、版本化，实现：</p><ul><li><strong>可回溯</strong>：每一次变更都有独立的 Python 脚本记录。</li><li><strong>可重复</strong>：在任何新环境中，执行同样的命令即可还原出完全一致的数据库结构。</li><li><strong>自动化</strong>：结合 CI/CD 实现零人工干预的数据库升级。</li></ul><h3 id="_1-2-核心术语" tabindex="-1">1.2 核心术语 <a class="header-anchor" href="#_1-2-核心术语" aria-label="Permalink to &quot;1.2 核心术语&quot;">​</a></h3><table tabindex="0"><thead><tr><th>术语</th><th>说明</th></tr></thead><tbody><tr><td><strong>Revision (版本)</strong></td><td>每一次数据库变更对应一个 Python 脚本文件（如 <code>ecf9656b368f_add_user_age.py</code>）。</td></tr><tr><td><strong>Upgrade (升级)</strong></td><td>执行迁移，将数据库结构升级到更新的版本。</td></tr><tr><td><strong>Downgrade (降级)</strong></td><td>回滚迁移，撤销上一次的操作。</td></tr><tr><td><strong>Head (最新)</strong></td><td>数据库版本链的顶端，即最新状态。</td></tr><tr><td><strong>Base (基准)</strong></td><td>数据库的初始状态（空库）。</td></tr></tbody></table><hr><h2 id="二、环境初始化与配置" tabindex="-1">二、环境初始化与配置 <a class="header-anchor" href="#二、环境初始化与配置" aria-label="Permalink to &quot;二、环境初始化与配置&quot;">​</a></h2><h3 id="_2-1-安装依赖" tabindex="-1">2.1 安装依赖 <a class="header-anchor" href="#_2-1-安装依赖" aria-label="Permalink to &quot;2.1 安装依赖&quot;">​</a></h3><p>推荐使用 <code>uv</code> 管理依赖，项目需包含 <code>alembic</code> 和异步驱动 <code>asyncpg</code>。</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">uv</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> add</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> alembic</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> asyncpg</span></span></code></pre></div><h3 id="_2-2-初始化项目-异步模式" tabindex="-1">2.2 初始化项目 (异步模式) <a class="header-anchor" href="#_2-2-初始化项目-异步模式" aria-label="Permalink to &quot;2.2 初始化项目 (异步模式)&quot;">​</a></h3><p>在后端项目根目录（如 <code>backend/</code>）执行：</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># -t async 参数至关重要，生成异步配置模板</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">uv</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> run</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> alembic</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> init</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -t</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> async</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> alembic</span></span></code></pre></div><h3 id="_2-3-关键配置修改" tabindex="-1">2.3 关键配置修改 <a class="header-anchor" href="#_2-3-关键配置修改" aria-label="Permalink to &quot;2.3 关键配置修改&quot;">​</a></h3><h4 id="_1-修改-alembic-ini" tabindex="-1">1. 修改 <code>alembic.ini</code> <a class="header-anchor" href="#_1-修改-alembic-ini" aria-label="Permalink to &quot;1. 修改 \`alembic.ini\`&quot;">​</a></h4><p>注释掉硬编码的数据库连接，避免敏感信息泄露，也便于动态读取环境变量。</p><div class="language-ini vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ini</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># alembic.ini</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># sqlalchemy.url = driver://user:pass@localhost/dbname  &lt;-- 注释掉这行</span></span></code></pre></div><h4 id="_2-配置-alembic-env-py-核心" tabindex="-1">2. 配置 <code>alembic/env.py</code> (核心) <a class="header-anchor" href="#_2-配置-alembic-env-py-核心" aria-label="Permalink to &quot;2. 配置 \`alembic/env.py\` (核心)&quot;">​</a></h4><p>这是 Alembic 的大脑，我们需要让它知道：</p><ol><li><strong>连接哪个数据库</strong>（从项目配置读取）。</li><li><strong>有哪些数据模型</strong>（导入所有 Model）。</li><li><strong>哪些表需要忽略</strong>（过滤掉不需要管理的表）。</li></ol><div class="language-python vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># backend/alembic/env.py 核心修改点</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 1. 导入项目配置和模型基类</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> core.config </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> settings</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> db.base </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Base</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 2. 【关键】导入所有业务模型，否则 autogenerate 无法检测到表！</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 必须显式导入所有包含 Model 定义的模块</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> modules.user </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> models </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">as</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> user_models</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> modules.file </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> models </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">as</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> file_models</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># ... 其他模块</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 3. 动态设置数据库连接 (覆盖 alembic.ini)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">config.set_main_option(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;sqlalchemy.url&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, settings.database_url)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 4. 配置 Metadata</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">target_metadata </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Base.metadata</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 5. 【进阶】配置 include_object 过滤不需要管理的表</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 例如：忽略 LangGraph 自动生成的 checkpoint 表</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> include_object</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(object, name, type_, reflected, compare_to):</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> type_ </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;table&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> and</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> name.startswith(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;checkpoint&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">):</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> False</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> True</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 在 context.configure 中注册 include_object</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> run_migrations_offline</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">():</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    context.configure(</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        # ... 其他配置</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">        include_object</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">include_object</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    )</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> do_run_migrations</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(connection):</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    context.configure(</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">        connection</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">connection,</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">        target_metadata</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">target_metadata,</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">        include_object</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">include_object  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 记得在 online 模式也加上</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    )</span></span></code></pre></div><hr><h2 id="三、实战操作手册" tabindex="-1">三、实战操作手册 <a class="header-anchor" href="#三、实战操作手册" aria-label="Permalink to &quot;三、实战操作手册&quot;">​</a></h2><p>本章节分为**“项目初始化”<strong>（首次引入 Alembic）和</strong>“日常开发迭代”**（后续更新）两部分，请根据当前阶段查阅。</p><h3 id="_3-1-阶段一-项目初始化-首次使用" tabindex="-1">3.1 阶段一：项目初始化 (首次使用) <a class="header-anchor" href="#_3-1-阶段一-项目初始化-首次使用" aria-label="Permalink to &quot;3.1 阶段一：项目初始化 (首次使用)&quot;">​</a></h3><p>这是从零开始让 Alembic 接管数据库的关键步骤。目标是生成第一个基准版本（Baseline）。</p><h4 id="_1-前置准备-至关重要" tabindex="-1">1. 前置准备 (至关重要) <a class="header-anchor" href="#_1-前置准备-至关重要" aria-label="Permalink to &quot;1. 前置准备 (至关重要)&quot;">​</a></h4><p>由于 <code>autogenerate</code> 的原理是 <strong>对比「代码中的 Model」和「数据库中的现有表」</strong>：</p><ul><li>如果数据库里已经有了表，Alembic 会觉得&quot;不需要创建&quot;，甚至会生成 <code>DROP TABLE</code>（因为它觉得已存在的表不在 metadata 里）。</li><li><strong>最佳实践</strong>：<strong>让 Alembic 面对一个空的数据库（Schema Public 为空）</strong>。</li></ul><h4 id="_2-操作步骤" tabindex="-1">2. 操作步骤 <a class="header-anchor" href="#_2-操作步骤" aria-label="Permalink to &quot;2. 操作步骤&quot;">​</a></h4><ol><li><p><strong>清理本地测试数据库</strong>（确保它是空的）：</p><ul><li>可以直接在数据库工具中执行：<code>DROP SCHEMA public CASCADE; CREATE SCHEMA public;</code></li><li>或者删除 Docker Volume 重建 DB 容器。</li></ul></li><li><p><strong>生成初始迁移脚本</strong>： 在 <code>backend</code> 目录下执行：</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">uv</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> run</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> alembic</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> revision</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --autogenerate</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -m</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;initial_schema&quot;</span></span></code></pre></div></li><li><p><strong>人工修正脚本 (必须检查！)</strong>： 打开生成的 <code>backend/alembic/versions/xxxx_initial_schema.py</code>，必须做以下检查：</p><ul><li><strong>检查 1：是否有 <code>import pgvector</code>？</strong><ul><li>如果有 <code>sa.Column(&#39;embedding&#39;, pgvector.sqlalchemy.vector.VECTOR(1536))</code>，文件头部<strong>必须</strong>手动添加 <code>import pgvector</code>。</li></ul></li><li><strong>检查 2：开启 Vector 扩展</strong><ul><li>在 <code>upgrade()</code> 函数的第一行，手动添加：</li></ul><div class="language-python vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> upgrade</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() -&gt; </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">None</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # 手动添加这一行，防止报错</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    op.execute(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;CREATE EXTENSION IF NOT EXISTS vector&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # ... 下面是 create_table ...</span></span></code></pre></div></li><li><strong>检查 3：是否有不该有的 Drop？</strong><ul><li>确认没有 <code>op.drop_table(&#39;checkpoint_...&#39;)</code>。如果有，说明 <code>env.py</code> 里的 <code>include_object</code> 配置没生效，或者您没有清空数据库。</li></ul></li></ul></li><li><p><strong>应用迁移</strong>：</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">uv</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> run</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> alembic</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> upgrade</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> head</span></span></code></pre></div></li><li><p><strong>验证</strong>： 查看数据库，表应该都创建好了，且 <code>alembic_version</code> 表里有一条记录。</p></li></ol><hr><h3 id="_3-2-阶段二-日常开发迭代-后续更新" tabindex="-1">3.2 阶段二：日常开发迭代 (后续更新) <a class="header-anchor" href="#_3-2-阶段二-日常开发迭代-后续更新" aria-label="Permalink to &quot;3.2 阶段二：日常开发迭代 (后续更新)&quot;">​</a></h3><p>当您开发新功能（例如给 User 表加个字段，或者新建一个 KnowledgeBase 表）时，遵循此流程。</p><h4 id="_1-修改代码-python" tabindex="-1">1. 修改代码 (Python) <a class="header-anchor" href="#_1-修改代码-python" aria-label="Permalink to &quot;1. 修改代码 (Python)&quot;">​</a></h4><p>在您的 <code>models.py</code> 中修改 SQLAlchemy 模型。</p><ul><li>例如：在 <code>User</code> 模型中添加 <code>age = Column(Integer, default=18)</code>。</li></ul><h4 id="_2-生成迁移脚本" tabindex="-1">2. 生成迁移脚本 <a class="header-anchor" href="#_2-生成迁移脚本" aria-label="Permalink to &quot;2. 生成迁移脚本&quot;">​</a></h4><p>执行命令，让 Alembic 自动检测差异：</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">uv</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> run</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> alembic</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> revision</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --autogenerate</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -m</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;add_age_to_user&quot;</span></span></code></pre></div><ul><li>注：<code>-m</code> 后面写清楚这次改了什么，方便以后查阅。</li></ul><h4 id="_3-审查脚本-code-review" tabindex="-1">3. 审查脚本 (Code Review) <a class="header-anchor" href="#_3-审查脚本-code-review" aria-label="Permalink to &quot;3. 审查脚本 (Code Review)&quot;">​</a></h4><p><strong>永远不要盲目信任 autogenerate！</strong> 打开生成的 <code>versions/xxxx_add_age_to_user.py</code>：</p><ul><li><strong>看 <code>upgrade()</code></strong>：是不是只有一个 <code>op.add_column</code>？有没有奇怪的 <code>op.drop_table</code>？</li><li><strong>看 <code>downgrade()</code></strong>：是不是对应的 <code>op.drop_column</code>？</li><li><strong>看 Imports</strong>：如果用到了特殊类型（如新加了 Vector 字段），确认文件头有没有 <code>import pgvector</code>。</li></ul><h4 id="_4-应用变更-local" tabindex="-1">4. 应用变更 (Local) <a class="header-anchor" href="#_4-应用变更-local" aria-label="Permalink to &quot;4. 应用变更 (Local)&quot;">​</a></h4><p>在本地开发环境应用变更，测试代码是否正常运行：</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">uv</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> run</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> alembic</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> upgrade</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> head</span></span></code></pre></div><h4 id="_5-提交代码-git" tabindex="-1">5. 提交代码 (Git) <a class="header-anchor" href="#_5-提交代码-git" aria-label="Permalink to &quot;5. 提交代码 (Git)&quot;">​</a></h4><p>将 <code>models.py</code> 的修改和 <code>alembic/versions/xxxx.py</code> 新生成的脚本<strong>一起提交</strong>到 Git 仓库。</p><ul><li><strong>切记</strong>：<code>versions</code> 文件夹里的脚本是代码的一部分，必须进版本控制。</li></ul><hr><h3 id="_3-3-关键注意事项清单-cheat-sheet" tabindex="-1">3.3 关键注意事项清单 (Cheat Sheet) <a class="header-anchor" href="#_3-3-关键注意事项清单-cheat-sheet" aria-label="Permalink to &quot;3.3 关键注意事项清单 (Cheat Sheet)&quot;">​</a></h3><ol><li><p><strong>关于 pgvector (向量库)</strong></p><ul><li><strong>痛点</strong>：Alembic 的 <code>autogenerate</code> 经常会漏掉 <code>import pgvector</code>。</li><li><strong>对策</strong>：每次生成脚本后，习惯性看一眼头部。如果报错 <code>NameError: name &#39;pgvector&#39; is not defined</code>，就是这个问题。</li></ul></li><li><p><strong>关于 LangGraph / LangChain 的表</strong></p><ul><li><strong>痛点</strong>：LangGraph 会自动在库里创建 <code>checkpoint_</code> 开头的表，Alembic 每次都想把它们删掉。</li><li><strong>对策</strong>：我们在 <code>env.py</code> 里配置了 <code>include_object</code> 函数来过滤 <code>checkpoint</code> 开头的表。确保不要误删该配置。</li></ul></li><li><p><strong>只有本地需要 autogenerate</strong></p><ul><li><strong>开发环境</strong>：运行 <code>revision --autogenerate</code> 生成脚本。</li><li><strong>生产/测试环境</strong>：<strong>绝对不要</strong>运行 <code>revision</code>。服务器上只运行 <code>upgrade head</code> 来消费你在本地生成的脚本。</li></ul></li><li><p><strong>团队协作冲突</strong></p><ul><li><strong>场景</strong>：你生成了一个版本 <code>rev_a</code>，你同事生成了 <code>rev_b</code>，你们的父版本都是 <code>rev_base</code>。这叫&quot;分叉 (Branching)&quot;。</li><li><strong>解决</strong>： <ol><li><code>uv run alembic heads</code> 会显示有分叉。</li><li><code>uv run alembic merge heads -m &quot;merge_branches&quot;</code> 合并分叉。</li><li>或者，在这个发生前，先拉取同事代码，<code>upgrade head</code> 到最新，然后再生成你的迁移脚本。</li></ol></li></ul></li><li><p><strong>如果搞砸了 (Undo)</strong></p><ul><li>如果你执行了 <code>upgrade</code> 但发现模型设计错了，想重来： <ol><li>执行 <code>uv run alembic downgrade -1</code>（回退一步）。</li><li>删除刚才生成的 <code>versions/xxxx.py</code> 文件。</li><li>修改 <code>models.py</code>。</li><li>重新生成 revision。</li></ol></li></ul></li></ol><hr><h2 id="四、生产环境部署方案" tabindex="-1">四、生产环境部署方案 <a class="header-anchor" href="#四、生产环境部署方案" aria-label="Permalink to &quot;四、生产环境部署方案&quot;">​</a></h2><p>在生产环境中，严禁手动修改数据库或手动运行迁移命令。推荐采用 <strong>GitOps + Init Container</strong> 模式。</p><h3 id="_4-1-核心原则" tabindex="-1">4.1 核心原则 <a class="header-anchor" href="#_4-1-核心原则" aria-label="Permalink to &quot;4.1 核心原则&quot;">​</a></h3><p><strong>“代码即真理”</strong>：Docker 镜像中必须包含生成的迁移脚本 (<code>versions/*.py</code>)。部署时，使用镜像内的脚本升级数据库。</p><h3 id="_4-2-部署流程" tabindex="-1">4.2 部署流程 <a class="header-anchor" href="#_4-2-部署流程" aria-label="Permalink to &quot;4.2 部署流程&quot;">​</a></h3>`,67)),(i(),o(d,null,{default:e(()=>[p(n,{id:"mermaid-531",class:"mermaid",graph:"sequenceDiagram%0A%20%20%20%20participant%20Dev%20as%20%E5%BC%80%E5%8F%91%E8%80%85%0A%20%20%20%20participant%20Git%20as%20Git%E4%BB%93%E5%BA%93%0A%20%20%20%20participant%20CI%20as%20CI%E6%9E%84%E5%BB%BA%0A%20%20%20%20participant%20Registry%20as%20%E9%95%9C%E5%83%8F%E4%BB%93%E5%BA%93%0A%20%20%20%20participant%20K8s%20as%20K8s%E9%9B%86%E7%BE%A4%0A%20%20%20%20participant%20DB%20as%20%E7%94%9F%E4%BA%A7%E6%95%B0%E6%8D%AE%E5%BA%93%0A%0A%20%20%20%20Dev-%3E%3EGit%3A%20%E6%8F%90%E4%BA%A4%E4%BB%A3%E7%A0%81%20%2B%20%E8%BF%81%E7%A7%BB%E8%84%9A%E6%9C%AC%0A%20%20%20%20Git-%3E%3ECI%3A%20%E8%A7%A6%E5%8F%91%E6%9E%84%E5%BB%BA%0A%20%20%20%20CI-%3E%3ECI%3A%20docker%20build%20(%E5%8C%85%E5%90%AB%20%2Falembic)%0A%20%20%20%20CI-%3E%3ERegistry%3A%20docker%20push%0A%20%20%20%20%0A%20%20%20%20K8s-%3E%3ERegistry%3A%20%E6%8B%89%E5%8F%96%E6%96%B0%E9%95%9C%E5%83%8F%0A%20%20%20%20%0A%20%20%20%20rect%20rgb(240%2C%20248%2C%20255)%0A%20%20%20%20%20%20%20%20note%20right%20of%20K8s%3A%20Init%20Container%20%E9%98%B6%E6%AE%B5%0A%20%20%20%20%20%20%20%20K8s-%3E%3EDB%3A%20alembic%20upgrade%20head%0A%20%20%20%20%20%20%20%20DB--%3E%3EK8s%3A%20%E6%95%B0%E6%8D%AE%E5%BA%93%E7%BB%93%E6%9E%84%E5%8D%87%E7%BA%A7%E5%AE%8C%E6%88%90%0A%20%20%20%20end%0A%20%20%20%20%0A%20%20%20%20rect%20rgb(240%2C%20255%2C%20240)%0A%20%20%20%20%20%20%20%20note%20right%20of%20K8s%3A%20Main%20Container%20%E9%98%B6%E6%AE%B5%0A%20%20%20%20%20%20%20%20K8s-%3E%3EDB%3A%20uvicorn%20%E5%90%AF%E5%8A%A8%E6%9C%8D%E5%8A%A1%0A%20%20%20%20%20%20%20%20K8s-%3E%3EDev%3A%20%E9%83%A8%E7%BD%B2%E6%88%90%E5%8A%9F%0A%20%20%20%20end%0A"})]),fallback:e(()=>[...s[0]||(s[0]=[r(" Loading... ",-1)])]),_:1})),s[2]||(s[2]=a(`<ol><li><p><strong>CI 构建阶段</strong>：</p><ul><li>执行 <code>docker build</code>。</li><li><code>COPY . /app</code> 指令将 <code>alembic/</code> 目录打入镜像。</li><li>产出包含最新代码和最新数据库版本的镜像。</li></ul></li><li><p><strong>CD 部署阶段 (K8s)</strong>：</p><ul><li>使用 <strong>Init Container</strong> 在主服务启动前执行迁移。</li><li>如果迁移失败，主服务不会启动，防止数据损坏。</li></ul></li></ol><p><strong>K8s Deployment 示例：</strong></p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">spec</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  template</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    spec</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      initContainers</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        - </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">db-migration</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">          image</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">my-repo/backend:latest</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  # 使用与业务相同的镜像</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">          # 覆盖启动命令，只执行数据库升级</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">          command</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;sh&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;-c&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;uv run alembic upgrade head&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">          envFrom</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            - </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">configMapRef</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">                name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">backend-config</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      containers</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        - </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">backend</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">          image</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">my-repo/backend:latest</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">          # 正常启动业务服务</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">          command</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;uvicorn&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;main:app&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;--host&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;0.0.0.0&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span></span></code></pre></div><hr><h2 id="五、关键坑点与解决方案" tabindex="-1">五、关键坑点与解决方案 <a class="header-anchor" href="#五、关键坑点与解决方案" aria-label="Permalink to &quot;五、关键坑点与解决方案&quot;">​</a></h2><h3 id="_5-1-初始迁移生成了空脚本" tabindex="-1">5.1 初始迁移生成了空脚本？ <a class="header-anchor" href="#_5-1-初始迁移生成了空脚本" aria-label="Permalink to &quot;5.1 初始迁移生成了空脚本？&quot;">​</a></h3><p><strong>现象</strong>：运行 <code>revision --autogenerate</code> 后，生成的 <code>upgrade()</code> 函数里是 <code>pass</code>。 <strong>原因</strong>：本地数据库的结构已经和代码一致了（可能之前自动创建过）。 <strong>解决</strong>：</p><ol><li><strong>方案 A (推荐)</strong>：清空本地数据库（<code>DROP SCHEMA public CASCADE; CREATE SCHEMA public;</code>），让 Alembic 看到一个空库，它才会生成 <code>CREATE TABLE</code> 语句。</li><li><strong>方案 B (保留数据)</strong>：手动创建一个临时的空数据库（<code>CREATE DATABASE temp_db</code>），连接该库生成脚本。</li></ol><h3 id="_5-2-生成了大量的-drop-table" tabindex="-1">5.2 生成了大量的 <code>DROP TABLE</code>？ <a class="header-anchor" href="#_5-2-生成了大量的-drop-table" aria-label="Permalink to &quot;5.2 生成了大量的 \`DROP TABLE\`？&quot;">​</a></h3><p><strong>现象</strong>：脚本里要把系统表或不需要管理的表删掉。 <strong>原因</strong>：<code>env.py</code> 中的 <code>target_metadata</code> 无法识别数据库中已存在的某些表（如 Celery 或 LangGraph 自动创建的表）。 <strong>解决</strong>：在 <code>env.py</code> 中配置 <code>include_object</code> 钩子函数，过滤掉这些表（见 2.3 节代码示例）。</p><h3 id="_5-3-远程数据库连接失败" tabindex="-1">5.3 远程数据库连接失败？ <a class="header-anchor" href="#_5-3-远程数据库连接失败" aria-label="Permalink to &quot;5.3 远程数据库连接失败？&quot;">​</a></h3><p><strong>现象</strong>：本地运行 Docker 容器连接远程库进行迁移时超时。 <strong>原因</strong>：网络白名单或 VPN 问题。 <strong>解决</strong>：确保本地 IP 在远程数据库的白名单内，或者直接在能访问数据库的跳板机上运行容器。</p><h3 id="_5-4-必须是-superuser-吗" tabindex="-1">5.4 必须是 Superuser 吗？ <a class="header-anchor" href="#_5-4-必须是-superuser-吗" aria-label="Permalink to &quot;5.4 必须是 Superuser 吗？&quot;">​</a></h3><p><strong>问题</strong>：执行迁移需要什么权限？ <strong>答案</strong>：</p><ul><li>普通表变更：只需要 Schema 的 DDL 权限（Create/Alter/Drop Table）。</li><li><strong>Vector 扩展</strong>：<code>CREATE EXTENSION vector</code> 通常需要 Superuser 权限。</li><li><strong>建议</strong>：联系 DBA 提前在库里执行一次 <code>CREATE EXTENSION vector;</code>，后续迁移即使用普通账号也能成功（脚本里的 <code>IF NOT EXISTS</code> 会跳过执行）。</li></ul><h3 id="_5-5-nameerror-name-pgvector-is-not-defined" tabindex="-1">5.5 NameError: name &#39;pgvector&#39; is not defined <a class="header-anchor" href="#_5-5-nameerror-name-pgvector-is-not-defined" aria-label="Permalink to &quot;5.5 NameError: name &#39;pgvector&#39; is not defined&quot;">​</a></h3><p><strong>现象</strong>：执行迁移时报错，提示找不到 <code>pgvector</code>。 <strong>原因</strong>：虽然 <code>models.py</code> 里导入了，但 Alembic 自动生成的迁移脚本文件头经常<strong>漏掉</strong>导入语句。 <strong>解决</strong>：手动在 <code>versions/xxxx.py</code> 文件头部添加 <code>import pgvector</code>。</p><hr><h2 id="六、常用命令速查" tabindex="-1">六、常用命令速查 <a class="header-anchor" href="#六、常用命令速查" aria-label="Permalink to &quot;六、常用命令速查&quot;">​</a></h2><p>所有命令需在 <code>backend</code> 目录下执行（或在 Docker 容器内）：</p><table tabindex="0"><thead><tr><th>场景</th><th>命令</th></tr></thead><tbody><tr><td><strong>生成自动迁移</strong></td><td><code>uv run alembic revision --autogenerate -m &quot;描述&quot;</code></td></tr><tr><td><strong>应用到最新</strong></td><td><code>uv run alembic upgrade head</code></td></tr><tr><td><strong>回滚一步</strong></td><td><code>uv run alembic downgrade -1</code></td></tr><tr><td><strong>回滚到指定版本</strong></td><td><code>uv run alembic downgrade &lt;revision_id&gt;</code></td></tr><tr><td><strong>查看迁移历史</strong></td><td><code>uv run alembic history</code></td></tr><tr><td><strong>查看当前状态</strong></td><td><code>uv run alembic current</code></td></tr><tr><td><strong>标记为最新 (不执行)</strong></td><td><code>uv run alembic stamp head</code> (慎用，仅用于修复版本记录)</td></tr></tbody></table><hr><h2 id="七、结语" tabindex="-1">七、结语 <a class="header-anchor" href="#七、结语" aria-label="Permalink to &quot;七、结语&quot;">​</a></h2><p>引入 Alembic 是项目走向成熟的标志。虽然初期配置和理解概念需要一定成本，但它带来的<strong>环境一致性</strong>和<strong>部署安全性</strong>是无价的。</p><p><strong>记住黄金法则</strong>：</p><blockquote><p><strong>修改模型 -&gt; 生成脚本 -&gt; 检查脚本 -&gt; 本地验证 -&gt; 提交代码</strong>。 永远不要手动修改生产数据库。</p></blockquote>`,26))])}const F=t(k,[["render",c]]);export{A as __pageData,F as default};
